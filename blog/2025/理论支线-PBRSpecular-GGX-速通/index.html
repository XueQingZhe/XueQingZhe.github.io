<!DOCTYPE html> <html lang="zh-CN"> <head> <meta http-equiv="Content-Type" content="text/html; charset=UTF-8"> <meta charset="utf-8"> <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"> <meta http-equiv="X-UA-Compatible" content="IE=edge"> <title> 理论支线：PBRSpecular - GGX 速通 | 吟处雪 轻遮 </title> <meta name="author" content="吟处雪 轻遮"> <meta name="description" content="理论支线：PBRSpecular - GGX"> <meta name="keywords" content="technical-artist, shader, rendering, unity, unreal-engine, pbr, toon-shading"> <link rel="stylesheet" href="/assets/css/bootstrap.min.css?a4b3f509e79c54a512b890d73235ef04"> <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/mdbootstrap@4.20.0/css/mdb.min.css" integrity="sha256-jpjYvU3G3N6nrrBwXJoVEYI/0zw8htfFnhT9ljN3JJw=" crossorigin="anonymous"> <link defer rel="stylesheet" href="/assets/css/academicons.min.css?f0b7046b84e425c55f3463ac249818f5"> <link defer rel="stylesheet" href="/assets/css/scholar-icons.css?62b2ac103a88034e6882a5be5f3e2772"> <link defer rel="stylesheet" type="text/css" href="https://fonts.googleapis.com/css?family=Roboto:300,400,500,700|Roboto+Slab:100,300,400,500,700|Material+Icons&amp;display=swap"> <link defer rel="stylesheet" href="/assets/css/jekyll-pygments-themes-github.css?591dab5a4e56573bf4ef7fd332894c99" media="" id="highlight_theme_light"> <link defer href="/assets/css/bootstrap-toc.min.css?6f5af0bb9aab25d79b2448143cbeaa88" rel="stylesheet"> <link rel="shortcut icon" href="data:image/svg+xml,&lt;svg%20xmlns=%22http://www.w3.org/2000/svg%22%20viewBox=%220%200%20100%20100%22&gt;&lt;text%20y=%22.9em%22%20font-size=%2290%22&gt;%E2%9A%9B%EF%B8%8F&lt;/text&gt;&lt;/svg&gt;"> <link rel="stylesheet" href="/assets/css/main.css?d41d8cd98f00b204e9800998ecf8427e"> <link rel="canonical" href="https://xueqingzhe.github.io/blog/2025/%E7%90%86%E8%AE%BA%E6%94%AF%E7%BA%BF-PBRSpecular-GGX-%E9%80%9F%E9%80%9A/"> <script src="/assets/js/theme.js?a81d82887dd692e91686b43de4542f18"></script> <link defer rel="stylesheet" href="/assets/css/jekyll-pygments-themes-native.css?5847e5ed4a4568527aa6cfab446049ca" media="none" id="highlight_theme_dark"> <script>
    initTheme();
  </script> <link defer rel="stylesheet" href="https://cdn.jsdelivr.net/npm/spotlight.js@0.7.8/dist/css/spotlight.min.css" integrity="sha256-Dsvkx8BU8ntk9Iv+4sCkgHRynYSQQFP6gJfBN5STFLY=" crossorigin="anonymous"> </head> <body class="fixed-top-nav "> <header> <nav id="navbar" class="navbar navbar-light navbar-expand-sm fixed-top" role="navigation"> <div class="container"> <a class="navbar-brand title font-weight-lighter" href="/"> <span class="font-weight-bold">吟处雪</span> 轻遮 </a> <button class="navbar-toggler collapsed ml-auto" type="button" data-toggle="collapse" data-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation"> <span class="sr-only">Toggle navigation</span> <span class="icon-bar top-bar"></span> <span class="icon-bar middle-bar"></span> <span class="icon-bar bottom-bar"></span> </button> <div class="collapse navbar-collapse text-right" id="navbarNav"> <ul class="navbar-nav ml-auto flex-nowrap"> <li class="nav-item "> <a class="nav-link" href="/">about </a> </li> <li class="nav-item active"> <a class="nav-link" href="/blog/">blog </a> </li> <li class="nav-item "> <a class="nav-link" href="/projects/">projects </a> </li> <li class="nav-item "> <a class="nav-link" href="/books/">books </a> </li> <li class="nav-item "> <a class="nav-link" href="/tutorials/">tutorials </a> </li> <li class="nav-item"> <button id="search-toggle" title="Search" onclick="openSearchModal()"> <span class="nav-link">ctrl k <i class="ti ti-search"></i></span> </button> </li> <li class="toggle-container"> <button id="light-toggle" title="Change theme"> <i class="ti ti-sun-moon" id="light-toggle-system"></i> <i class="ti ti-moon-filled" id="light-toggle-dark"></i> <i class="ti ti-sun-filled" id="light-toggle-light"></i> </button> </li> </ul> </div> </div> </nav> <progress id="progress" value="0"> <div class="progress-container"> <span class="progress-bar"></span> </div> </progress> </header> <div class="container mt-5" role="main"> <div class="row"> <div class="col-sm-3"> <nav id="toc-sidebar" class="sticky-top"></nav> </div> <div class="col-sm-9"> <div class="post"> <header class="post-header"> <h1 class="post-title">理论支线：PBRSpecular - GGX 速通</h1> <p class="post-meta"> Created on December 27, 2025 </p> <p class="post-tags"> <a href="/blog/2025"> <i class="fa-solid fa-calendar fa-sm"></i> 2025 </a>   ·   <a href="/blog/tag/shader"> <i class="fa-solid fa-hashtag fa-sm"></i> shader</a>   <a href="/blog/tag/rendering"> <i class="fa-solid fa-hashtag fa-sm"></i> rendering</a>   <a href="/blog/tag/math"> <i class="fa-solid fa-hashtag fa-sm"></i> math</a>   ·   <a href="/blog/category/tamonth01"> <i class="fa-solid fa-tag fa-sm"></i> TAMonth01</a> </p> </header> <article class="post-content"> <div id="markdown-content"> <h1 id="pbr-核心理论">PBR 核心理论</h1> <h2 id="什么是-pbr-physically-based-rendering">什么是 PBR (Physically Based Rendering)</h2> <p>PBR 是一种基于物理原理的渲染方法，目标是<strong>在任何光照条件下都能得到物理正确的结果</strong>。 PBR 的核心理念：漫反射 + 镜面反射 = 完整的表面反射 <strong>基于微表面理论这是重点</strong> \(f_r(l, v) = \underbrace{f_{diff}}_{\text{漫反射}} + \underbrace{f_{spec}}_{\text{镜面反射}}\) <strong>核心思想三要素：</strong></p> <ul> <li> <strong>能量守恒</strong> (Energy Conservation)：反射光不能超过入射光</li> <li> <strong>基于微表面理论</strong> (Microfacet Theory)：表面由无数微小镜面组成</li> <li> <strong>使用真实物理参数</strong>：金属度(Metallic)、粗糙度(Roughness)替代传统的高光参数</li> </ul> <p>![[Pasted image 20251227192945.png]]</p> <h1 id="specular-brdf">Specular BRDF</h1> <p><strong>PBR与传统模型区别主要是在高光，漫反射其实还是Lambert</strong></p> <p>\(f_{specColor}(l, v) = \frac{D(h) \cdot F(v, h) \cdot G(l, v, h)}{4 \cdot (n \cdot l) \cdot (n \cdot v)}\cdot NoL \cdot SpecularColor\)</p> <h2 id="镜面反射-brdf-cook-torrance">镜面反射 BRDF (Cook-Torrance)</h2> <p>\(f_{spec}(l, v) = \frac{D(h) \cdot F(v, h) \cdot G(l, v, h)}{4 \cdot (n \cdot l) \cdot (n \cdot v)}\) <strong>记忆口诀：DFG 除以 4NL·NV</strong> <strong>D</strong> - Distribution (法线分布) - 高光形状 <strong>F</strong> - Fresnel (菲涅尔) - 反射率 <strong>G</strong> - Geometry (几何项) - 遮挡 <strong>分母</strong> - 归一化因子</p> <p><strong>这里会考虑三个关键问题</strong> Cook-Torrance 的 D、F、G 三项分别回答：</p> <ol> <li> <strong>D 项</strong>：微镜面法线如何分布？（高光形状）</li> <li> <strong>F 项</strong>：每个微镜面反射多少光？（反射强度）</li> <li> <strong>G 项</strong>：有多少微镜面被遮挡？（自遮挡修正）</li> </ol> <h3 id="d--distribution高光项公式">D- Distribution高光项公式</h3> <p><strong>问题</strong>：在给定方向 <code class="language-plaintext highlighter-rouge">h</code>（半程向量），有多少比例的微镜面法线指向 <code class="language-plaintext highlighter-rouge">h</code>？ 入射光 L 和反射光 V 的中间方向 = H (Half Vector) 只有法线 = H 的微镜面才能将 L 反射到 V D(h) = 在方向 h 附近的微镜面密度</p> <p><strong>这里使用的高光计算公式是 GGX/Trowbridge-Reitz 公式</strong></p> <p>\(D_{GGX}(h) = \frac{\alpha^2}{\pi \left[ (n \cdot h)^2 (\alpha^2 - 1) + 1 \right]^2}\) ​</p> <p><strong>参数：</strong></p> <ul> <li>α(粗糙度参数 / GGX 粗糙度)和粗糙度的平方相关\(α=roughness^2\)</li> <li>法线和半程向量的点积，这里其实就是Blinn-Phong\(n⋅h\) <h3 id="f-项---fresnel菲涅尔">F 项 - Fresnel（菲涅尔）</h3> <p><strong>F0：</strong> Fresnel at 0 degrees，正入射时的反射率（垂直看表面时的反射率），简单来说就是视线和法线夹角为0度的时候的反射率 \(F_0​=lerp(0.04,baseColor,metallic)\)</p> </li> <li>非金属（metallic=0）：F0 = 0.04（灰色）</li> <li>金属（metallic=1）：F0 = baseColor（彩色）</li> </ul> <p><strong>F:</strong> 菲涅尔项 <strong>精确的公式</strong> \(F(v,h)=F_0​+(F_{90}−F_0​)⋅(1−(v⋅h))^5\) <strong>通常在视角和法线成90度也叫掠射角，可以理解为此时进入眼睛能观察的光线是与表面平行，那么相当于表面完全反射此部分的光线，所以几乎所有材质的F90反射率都是为1，所以红色可以化简</strong> \(F_{90} = 1\) <strong>这里需要注意，它的参数是v⋅h，并非宏观的下的fresnel（NoV），这里实际是取的微观表面的法线，不论宏观还是微观，它都满足入射角和出射角相等，那么L是入射，V是就是出射，那么微观平面法线就可以理解为L和V的角平分线也就是H(H=L+V)，这样就把fresnel（NoV）中的法线N替换，就是v⋅h了</strong> \(F(v,h)=F_0​+(1−F_0​)⋅(1−(v⋅h))^5\) <strong>因为入射和反射对称，所以用l⋅h也是对的</strong> \(F(v,h)=F_0​+(1−F_0​)⋅(1−(l⋅h))^5\)</p> <h3 id="g-项---geometry几何函数">G 项 - Geometry（几何函数）</h3> <h4 id="公式smith-ggx">公式：Smith-GGX</h4> \[G(l, v, h) = G_1(l) \cdot G_1(v)\] <p>其中可视性遮蔽：</p> <p>\(G_1(v) = \frac{n \cdot v}{(n \cdot v) \cdot (1 - k) + k}\)​ 其中光线遮蔽： \(G_1(l) = \frac{n \cdot l}{(n \cdot l) \cdot (1 - k) + k}\)</p> <p><strong>k 的计算（直接光照）：</strong></p> <p>\(k = \frac{(\text{roughness} + 1)^2}{8}\)<strong>环境光K</strong> \(k = \frac{\text{roughness}^2}{2}\)​</p> <h1 id="对于d高光项计算公式的由来和解释">对于D高光项计算公式的由来和解释</h1> <p><strong>α 的定义</strong> α 是微表面斜率的标准差（Standard Deviation of Microfacet Slopes） 直白理解： <strong><em>就是GGX的专用粗糙度系数</em></strong> α 越大 → 微镜面法线越分散 → 高光越宽 α 越小 → 微镜面法线越集中 → 高光越尖 <strong>为什么要粗糙度的平方？</strong></p> <div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr>
<td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre></td> <td class="rouge-code"><pre> <span class="c1">// 用户输入的粗糙度（线性感知） </span>
 <span class="kt">float</span> <span class="n">roughness</span> <span class="o">=</span> <span class="mi">0</span><span class="p">.</span><span class="mi">5</span><span class="p">;</span> <span class="c1">// [0, 1] 范围 </span>
 <span class="c1">// GGX 使用的参数 </span>
 <span class="kt">float</span> <span class="n">alpha</span> <span class="o">=</span> <span class="n">roughness</span> <span class="o">*</span> <span class="n">roughness</span><span class="p">;</span> <span class="c1">// α = 0.25 </span>
</pre></td> </tr></tbody></table></code></pre></div></div> <p><strong>原因：</strong></p> <ol> <li> <strong>感知线性化</strong>（Perceptual Linearization） <div class="language-c highlighter-rouge"> <div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr>
<td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre></td> <td class="rouge-code"><pre><span class="err">人眼对粗糙度的感知不是线性的</span>  
<span class="n">roughness</span> <span class="o">=</span> <span class="mi">0</span><span class="p">.</span><span class="mi">5</span> <span class="err">时，看起来像</span><span class="s">"中等粗糙"</span>
<span class="err">但如果直接用</span> <span class="err">α</span> <span class="o">=</span> <span class="mi">0</span><span class="p">.</span><span class="mi">5</span><span class="err">，视觉上会太粗糙</span>
<span class="err">平方后</span> <span class="err">α</span> <span class="o">=</span> <span class="mi">0</span><span class="p">.</span><span class="mi">25</span><span class="err">，视觉效果更符合直觉</span>
</pre></td> </tr></tbody></table></code></pre></div> </div> <p><strong>Disney 的研究成果</strong></p> <ul> <li>Disney 在《Physically Based Shading at Disney》中提出</li> <li>测试发现：α=roughness2^ 的调节曲线最符合艺术家直觉</li> <li>现在成为行业标准</li> </ul> </li> </ol> \[D_{GGX}(h) = \frac{\alpha^2}{\pi \left[ (n \cdot h)^2 (\alpha^2 - 1) + 1 \right]^2}\] <p>roughness ∈ $[0, 1]$ -&gt;平方 α ∈ $[0, 1]$ 但实际使用： roughness = 0.0 → α = 0.0 (完美镜面，会导致除零) roughness = 1.0 → α = 1.0 (完全粗糙) 所以通常会</p> <div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr>
<td class="rouge-gutter gl"><pre class="lineno">1
</pre></td> <td class="rouge-code"><pre><span class="nl">clamp:</span> <span class="kt">float</span> <span class="n">alpha</span> <span class="o">=</span> <span class="n">max</span><span class="p">(</span><span class="n">roughness</span> <span class="o">*</span> <span class="n">roughness</span><span class="p">,</span> <span class="mi">0</span><span class="p">.</span><span class="mo">001</span><span class="p">);</span> <span class="c1">// 避免除零 </span>
</pre></td> </tr></tbody></table></code></pre></div></div> <h2 id="关于柯西公式">关于柯西公式</h2> <p><strong>标准柯西分布</strong>（Cauchy Distribution）：</p> <p>\(p(x) = \frac{1}{\pi (1 + x^2)}\)<strong>带尺度参数 γ (gamma)的柯西分布：</strong></p> <p>\(p(x; \gamma) = \frac{1}{\pi \gamma \left(1 + \frac{x^2}{\gamma^2}\right)}\)​</p> <p><strong>进一步变形：</strong></p> <p>\((x; \gamma) = \frac{1}{\pi \gamma} \cdot \frac{\gamma^2}{\gamma^2 + x^2}\)​</p> <p><strong>整理成分子分母：</strong></p> <p>\(p(x; \gamma) = \frac{\gamma^2}{\pi (\gamma^2 + x^2)}\)​ <strong>二维柯西公式</strong> \(p(m_x​,m_y​)=\frac{\gamma^2}{π(\gamma^2+m_x^2​+m_y^2​)^2}\)​</p> <p><strong>GGX高光的起点：假设微表面斜率服从带尺度参数 γ (gamma)柯西分布，这个尺度就是粗糙度参数</strong></p> <h2 id="如何描述微观平面的粗糙度变化量x">如何描述微观平面的粗糙度变化量X</h2> <p>真实表面是 <strong>“高度场”</strong>，不是 <strong>“角度场”</strong></p> <blockquote> <p><strong>真实世界里的粗糙表面是什么？</strong></p> </blockquote> <p>不管是：</p> <ul> <li> <p>打磨</p> </li> <li> <p>抛光</p> </li> <li> <p>拉丝</p> </li> <li> <p>喷砂</p> </li> </ul> <p>本质都是：</p> <blockquote> <p><strong>在一个平面上制造“高度起伏”</strong></p> </blockquote> <p><strong>问题：</strong> 如何描述表面的粗糙程度？ <strong>传统想法（错误）：</strong> 用法线的角度分布？ <strong>问题：</strong> 法线角度不直观，难以度量 <strong>正确方法：</strong> 用表面的高度变化！</p> <p><strong>因为是微观平面也就是微表面模型下，决定粗糙度与否的其实就是表面的高低起伏，也就是每一个微观平面与宏观平面所构成的斜率</strong> ![[ffb807b5-4259-4535-af3f-832a9eaf052a.png]]</p> <p>想象用手摸一个粗糙表面： - 光滑 → 高度变化小 → 斜率小 - 粗糙 → 高度起伏大 → 斜率大 <strong>斜率定义：</strong> \(p = \frac{\Delta x}{\Delta z}, \quad q = \frac{\Delta y}{\Delta z}\) 物理意义： - p：x 方向的坡度 - q：y 方向的坡度 - 斜率越大 → 表面越陡峭 → 越粗糙 <strong>这里的斜率其实是有两个分量方向的斜率的，图上仅画了x方向的斜率</strong> \(p=\frac{Δx}{Δz}​,q=\frac{Δy}{Δz}\)​ <strong>所以现在X变量和尺度值α（粗糙度）都有了，如果代入公式就可以得到一个结果了。但是这里有一个问题，那就是现在的X变量其实是实际不存在的微表面参数空间下的变量，而非我们肉眼看见的宏观平面，那么这样的话我们就需要进行空间转换了。</strong> <strong><em>二维的柯西分布公式</em></strong> \(p(mx​,my​)=\frac{\gamma^2}{π(\gamma^2+mx^2​+my^2​)^2}\) <strong><em>但是我们需要的是二维的柯西分布公式，代入数值之后</em></strong> \(p(p,q)=\frac{α^2}{π(p^2+q^2+α^2)^2}\) <strong><em>这和最终的D_GGX公式还是差一点</em></strong> \(D_{GGX}(h) = \frac{\alpha^2}{\pi \left[ (n \cdot h)^2 (\alpha^2 - 1) + 1 \right]^2}\)​</p> <p><strong>那么暂时总结一下就是下面几点：</strong> GGX 中使用的柯西分布最初定义在<strong>微表面斜率空间（slope plane）</strong> 上，<br> 该空间并不是法线方向的半球；<br> 而 BRDF 需要的是微表面法线在<strong>单位半球</strong>上的分布。<br> 因此必须将<strong>斜率空间</strong>映射到<strong>方向空间</strong>，<br> 并通过 <strong>Jacobian</strong> 修正映射过程中面积（权重）的变化。</p> <h2 id="雅可比jacobian-矩阵行列式">雅可比(Jacobian )矩阵/行列式</h2> <blockquote> <p><strong>Jacobian = 当我用新变量来描述同一批东西时，<br> 一个“单位面积”被拉伸或压缩了多少，这里核心思想是描述局部线性变换</strong></p> </blockquote> <p><strong>为什么需要 Jacobian？</strong> 简单来说：我们有斜率空间 (p,q) 的分布， 但 BRDF 需要的是法线方向 (θ,φ) 的分布。 变量变换时，概率密度需要乘以一个”缩放因子”， 这个因子就是 Jacobian 行列式 |J|。</p> <p>斜率空间的分布： p(slope_x, slope_y) 需要转换到： D(法线方向 h) 工具： Jacobian 矩阵（变量变换）</p> <p>斜率定义转换到半球空间： \(p = \frac{Δx}{Δz} = tan(θ) \cdot cos(φ)\) \(q = \frac{Δy}{Δz} = tan(θ)\cdot sin(φ)\)</p> <p>其中： θ = 微平面法线与宏观法线 N 的夹角 φ = 方位角</p> <h3 id="求偏导">求偏导</h3> <h4 id="p-对-θ-的偏导">p 对 θ 的偏导</h4> <p><strong>将φ看成常数 - 得到 ∂p/∂θ 和 ∂p/∂φ</strong> 意思就是求原始p分量在变换后对θ分量的分别贡献</p> <p><strong>函数</strong> \(p = \tan(\theta) \cos(\phi)\) <strong>求偏导（φ 看作常数）：</strong></p> <p>\(\frac{\partial p}{\partial \theta} = \frac{\partial}{\partial \theta}[\tan(\theta) \cos(\phi)]\) <strong>常数cosφ提出来</strong> \(=cos(ϕ)⋅\frac{∂}{θ∂}​[tan(θ)]\) <strong>tan(θ) 的导数</strong> \(= \cos(\phi) \cdot \sec^2(\theta)\) <strong>最终结果</strong> \(= \sec^2(\theta) \cdot \cos(\phi)\)</p> <h4 id="p-对-φ-的偏导">p 对 φ 的偏导</h4> <p><strong>将θ看成常数 - 得到 ∂p/∂θ 和 ∂p/∂φ</strong> 意思就是求原始p分量在变换后对φ分量的分别贡献</p> <p><strong>函数</strong> \(p=tan(θ)cos(ϕ)\) <strong>求偏导（θ 看作常数）：</strong></p> \[\frac{\partial p}{\partial \phi} = \frac{\partial}{\partial \phi}[\tan(\theta) \cos(\phi)]\] <p><strong>常数tanθ提出来</strong> \(=\tan(\partial)⋅\frac{\partial}{\partial\phi​}[\cos(\phi)]\)</p> <p><strong>cos(φ) 的导数</strong> \(= \tan(\theta) \cdot (-\sin(\phi))\) <strong>最终结果</strong> \(=-\tan(\theta) \sin(\phi)\)</p> <p><strong>所以p对φ和θ方向的贡献就有了，也就是雅可比矩阵的第一行</strong> $$ \begin{bmatrix} \frac{\partial p}{\partial \theta} &amp; \frac{\partial p}{\partial \phi} \</p> <p>\end{bmatrix}\(\)\begin{bmatrix} \sec^2(\theta) \cos(\phi) &amp; -\tan(\theta) \sin(\phi) \end{bmatrix}$$</p> <h4 id="q-对-θ-的偏导">q 对 θ 的偏导</h4> <p><strong>函数：</strong></p> \[q = \tan(\theta) \sin(\phi)\] <p><strong>求偏导（φ 看作常数）：</strong></p> \[\frac{\partial q}{\partial \theta} = \frac{\partial}{\partial \theta}[\tan(\theta) \sin(\phi)]\] <p><strong>常数sinφ提出来</strong> \(= \sin(\phi) \cdot \frac{\partial}{\partial \theta}[\tan(\theta)]\)</p> <p><strong>tan(θ) 的导数</strong>* \(= \sin(\phi) \cdot \sec^2(\theta)\)</p> <p><strong>最终结果</strong> \(= \sec^2(\theta) \sin(\phi)\)</p> <h4 id="q-对-φ-的偏导">q 对 φ 的偏导</h4> <p><strong>函数：</strong></p> \[q = \tan(\theta) \sin(\phi)\] <p><strong>求偏导（θ 看作常数）：</strong></p> <p>\(\frac{\partial q}{\partial \phi} = \frac{\partial}{\partial \phi}[\tan(\theta) \sin(\phi)]\) <strong>常数提tanθ出来</strong> \(= \tan(\theta) \cdot \frac{\partial}{\partial \phi}[\sin(\phi)]\)</p> <p><strong>sin(φ) 的导数</strong> \(= \tan(\theta) \cdot \cos(\phi)\)</p> <p><strong>最终结果</strong> \(= \tan(\theta) \cos(\phi)\)</p> <p><strong>所以q对φ和θ方向的贡献就有了，也就是雅可比矩阵的第二行</strong> \(\begin{bmatrix} \frac{\partial q}{\partial \theta} &amp; \frac{\partial q}{\partial \phi} \end{bmatrix}\) \(\begin{bmatrix} \sec^2(\theta) \sin(\phi) &amp; \tan(\theta) \cos(\phi) \end{bmatrix}\)</p> <h3 id="组成雅可比jacobian-矩阵">组成雅可比Jacobian 矩阵</h3> <p>\(J = \begin{bmatrix} \frac{\partial p}{\partial \theta} &amp; \frac{\partial p}{\partial \phi} \\ \frac{\partial q}{\partial \theta} &amp; \frac{\partial q}{\partial \phi} \end{bmatrix}\)</p> \[J = \begin{bmatrix} \sec^2(\theta) \cos(\phi) &amp; -\tan(\theta) \sin(\phi) \\ \sec^2(\theta) \sin(\phi) &amp; \tan(\theta) \cos(\phi) \end{bmatrix}\] <p>因为我们处理的是一个<strong>面积缩放</strong>，需要的是一个缩放的<strong>标量</strong>，而非矩阵变换，所以此处对矩阵采用行列式形式计算提取一个值 应用 2×2 行列式公式 \(\begin{vmatrix} a &amp; b \\ c &amp; d \end{vmatrix} = ad - bc​\) \(|J| = \sec^2(\theta) \cos(\phi) \cdot \tan(\theta) \cos(\phi) - [-\tan(\theta) \sin(\phi)] \cdot \sec^2(\theta) \sin(\phi)\) \(= \sec^2(\theta) \tan(\theta) \cos^2(\phi) + \sec^2(\theta) \tan(\theta) \sin^2(\phi)\) <strong>化简（这是化简行列式，不是矩阵）</strong></p> <p>\(|J| = \sec^2(\theta) \tan(\theta) \cos^2(\phi) + \sec^2(\theta) \tan(\theta) \sin^2(\phi)\) \(= \sec^2(\theta) \tan(\theta) [\cos^2(\phi) + \sin^2(\phi)]\) \(= \sec^2(\theta) \tan(\theta)\) \(= \frac{\sin(\theta)}{\cos^3(\theta)}\)</p> <p><strong>单位面积的缩放：</strong></p> <p>输入空间：dθ × dφ（单位面积） ↓ 变换 输出空间：|J| × dθ × dφ（变换后面积）</p> <table> <tbody> <tr> <td>J</td> <td>= 面积放大/缩小因子</td> </tr> </tbody> </table> <p>概率守恒： \(p(θ, φ) dθ dφ = p(p, q) dp dq\) \(p(θ, φ) dθ dφ= p(p,q) dθ dφ × |J|\) 所以： \(p(p, q) = p(θ, φ) / |J|\)</p> <p>代入 \(|J| = \frac{\sin(\theta)}{\cos^3(\theta)}\) 得到 \(p(p, q) = p(\theta, \phi) \cdot \frac{\cos^3(\theta)}{\sin(\theta)}\)​</p> <p><strong>现在就有(p,q) → (θ,φ)最终的雅可比了，也就是已经转换到宏观空间了，但是还需要转换到球面空间</strong></p> <p><strong>立体角微元:</strong> \(dω = sin(θ) dθ dφ\)</p> <p><strong>从 (p,q) 到立体角：</strong></p> <p>\(dp \, dq = \frac{\sin(\theta)}{\cos^3(\theta)} d\theta \, d\phi\) \(=\frac{1}{\cos^3(\theta)} \cdot \sin(\theta) d\theta d\phi\) \(=\frac{1}{\cos^3(\theta)} \cdot d\omega\) \(= \frac{d\omega}{\cos^3(\theta)}\) <strong>还需要考虑单位球上投影：</strong> 投影到法线空间的”面积”元素需要除以 cos⁡(θ)：</p> <p>\(dA_h = \frac{d\omega}{\cos(\theta)}\) 也就是 \(d\omega= \frac{dA_h}{\cos(\theta)}\) <strong>代入分布</strong></p> <p>\(dp \, dq = \frac{d\omega}{\cos^3(\theta)}\) \(= \frac{dA_h / \cos(\theta)}{\cos^3(\theta)}\) \(=\frac{dA_h}{\cos^4(\theta)}\) <strong>所以最终得到结果是</strong> \(|J| =\frac{dA_h}{\cos^4(\theta)}\) <strong>概率密度变换</strong></p> <p>\(p(p, q) \, dp \, dq = D(h) \, dA_h\) \(D(h) = p(p, q) \frac{dp \, dq}{dA_h}\) \(= p(p, q) \frac{dA_h / \cos^4(\theta)}{dA_h}\)\(= \frac{p(p, q)}{\cos^4(\theta)}\)</p> <p><strong>根据点乘定义，这里定义n和h都是单位向量，所以结果是cos(θ)</strong> \(n \cdot h = cos(θ)\) <strong>所以有：</strong></p> <p>\(\cos(\theta) = n \cdot h\) <strong>代入 cos(θ)，得到了最终的分布关系</strong></p> \[D(h) = \frac{p(p, q)}{(n \cdot h)^4}\] <h3 id="微表面斜率空间转到宏观法线">微表面斜率空间转到宏观法线</h3> <p><strong>当前微表面的法线表示是(p,q,1)，但是我们需要进行归一化</strong> <strong><em>归一化因子就是所有分量的平方相加在开方</em></strong> \(|h_{raw}| = \sqrt{p^2 + q^2 + 1^2} = \sqrt{p^2 + q^2 + 1}\)</p> <p>\(h = \frac{h_{raw}}{|h_{raw}|} = \frac{(p, q, 1)}{\sqrt{p^2 + q^2 + 1}}\) <strong>即：</strong></p> \[h = \left( \frac{p}{\sqrt{p^2+q^2+1}}, \frac{q}{\sqrt{p^2+q^2+1}}, \frac{1}{\sqrt{p^2+q^2+1}} \right)\] <p><strong>点积计算</strong> <strong>这里左侧表示宏观计算noh,右侧则是微观的noh，它们在数值上应该相等</strong> \(n\cdot h = (0, 0, 1) \cdot \frac{(p, q, 1)}{\sqrt{p^2 + q^2 + 1}}\)</p> <p><strong>展开点积：</strong></p> <p>\(= \frac{0 \times p + 0 \times q + 1 \times 1}{\sqrt{p^2 + q^2 + 1}}\) \(= \frac{1}{\sqrt{p^2 + q^2 + 1}}\)</p> <p>**现在就可以反向求解p和q</p> \[p^2 + q^2 = \frac{1 - (n \cdot h)^2}{(n \cdot h)^2}\] <p><strong>代入$p^2$+$q^2$</strong> 我们有： - 柯西分布：$p(p,q) = \frac{\alpha^2}{\pi(p^2+q^2+\alpha^2)^2}$ - 几何关系：$p^2 + q^2 = \frac{1-(n \cdot h)^2}{(n \cdot h)^2}$ \(p(p,q)=\frac{α^2}{π(p^2+q^2+α^2)^2}\) <strong>得到</strong> \(p(p, q) = \frac{\alpha^2 (n \cdot h)^4}{\pi [(n \cdot h)^2(\alpha^2 - 1) + 1]^2}\)</p> <p>根据前面得到的关系 \(D(h) = \frac{p(p, q)}{(n \cdot h)^4}\)</p> <p><strong>最终最终得到</strong> \(D_{GGX}(h) = \frac{\alpha^2}{\pi \left[ (n \cdot h)^2 (\alpha^2 - 1) + 1 \right]^2}\)</p> <h1 id="对于f菲涅尔项的公式由来和解释">对于F菲涅尔项的公式由来和解释</h1> <h2 id="精确-fresnel-方程1823">精确 Fresnel 方程（1823）</h2> <div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr>
<td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
</pre></td> <td class="rouge-code"><pre><span class="err">发明者：</span><span class="n">Augustin</span><span class="o">-</span><span class="n">Jean</span> <span class="n">Fresnel</span><span class="err">（法国物理学家）</span>
<span class="err">年代：</span>  <span class="mi">1823</span> <span class="err">年</span>
<span class="err">用途：</span>  <span class="err">光学、物理学</span>

<span class="err">公式：</span>
  <span class="n">Rs</span> <span class="o">=</span> <span class="o">|</span><span class="n">n</span><span class="err">₁</span><span class="n">cos</span><span class="err">θᵢ</span> <span class="o">-</span> <span class="n">n</span><span class="err">₂</span><span class="n">cos</span><span class="err">θₜ</span><span class="o">|</span><span class="err">²</span>
       <span class="o">|</span><span class="n">n</span><span class="err">₁</span><span class="n">cos</span><span class="err">θᵢ</span> <span class="o">+</span> <span class="n">n</span><span class="err">₂</span><span class="n">cos</span><span class="err">θₜ</span><span class="o">|</span>
       
  <span class="n">Rp</span> <span class="o">=</span> <span class="o">|</span><span class="n">n</span><span class="err">₁</span><span class="n">cos</span><span class="err">θₜ</span> <span class="o">-</span> <span class="n">n</span><span class="err">₂</span><span class="n">cos</span><span class="err">θᵢ</span><span class="o">|</span><span class="err">²</span>
       <span class="o">|</span><span class="n">n</span><span class="err">₁</span><span class="n">cos</span><span class="err">θₜ</span> <span class="o">+</span> <span class="n">n</span><span class="err">₂</span><span class="n">cos</span><span class="err">θᵢ</span><span class="o">|</span>
       
  <span class="n">R</span> <span class="o">=</span> <span class="p">(</span><span class="n">Rs</span> <span class="o">+</span> <span class="n">Rp</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span>

<span class="err">需要：</span>
  <span class="n">n</span><span class="err">₁</span> <span class="o">=</span> <span class="err">空气折射率</span> <span class="p">(</span><span class="mi">1</span><span class="p">.</span><span class="mi">0</span><span class="p">)</span>
  <span class="n">n</span><span class="err">₂</span> <span class="o">=</span> <span class="err">材质折射率</span> <span class="p">(</span><span class="mi">1</span><span class="p">.</span><span class="mi">5</span><span class="p">,</span> <span class="mi">1</span><span class="p">.</span><span class="mi">33</span><span class="p">,</span> <span class="p">...)</span>
  <span class="err">θᵢ</span> <span class="o">=</span> <span class="err">入射角</span>
  <span class="err">θₜ</span> <span class="o">=</span> <span class="err">折射角（由</span> <span class="n">Snell</span> <span class="err">定律算出）</span>
  
<span class="err">特点：</span>
  <span class="err">✅</span> <span class="err">完全精确</span>
  <span class="err">✅</span> <span class="err">物理正确</span>
  <span class="err">❌</span> <span class="err">计算复杂</span>
  <span class="err">❌</span> <span class="err">需要</span> <span class="n">IOR</span>
  <span class="err">❌</span> <span class="err">需要</span> <span class="n">Snell</span> <span class="err">定律</span>
  <span class="err">❌</span> <span class="n">GPU</span> <span class="err">上慢</span>
</pre></td> </tr></tbody></table></code></pre></div></div> <h2 id="schlick-近似1994">Schlick 近似（1994）</h2> <div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr>
<td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
</pre></td> <td class="rouge-code"><pre><span class="err">发明者：</span><span class="n">Christophe</span> <span class="n">Schlick</span>
<span class="err">年代：</span>  <span class="mi">1994</span> <span class="err">年</span>
<span class="err">用途：</span>  <span class="err">实时渲染、游戏</span>

<span class="err">公式：</span>
  <span class="n">F</span><span class="p">(</span><span class="err">θ</span><span class="p">)</span> <span class="o">=</span> <span class="n">F</span><span class="err">₀</span> <span class="o">+</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">F</span><span class="err">₀</span><span class="p">)(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">cos</span><span class="err">θ</span><span class="p">)</span><span class="err">⁵</span>

<span class="err">需要：</span>
  <span class="n">F</span><span class="err">₀</span> <span class="o">=</span> <span class="err">基础反射率（可以从</span> <span class="n">IOR</span> <span class="err">预计算）</span>
  <span class="n">cos</span><span class="err">θ</span> <span class="o">=</span> <span class="err">角度余弦（一个点积）</span>
  
<span class="err">特点：</span>
  <span class="err">✅</span> <span class="err">简单（一个</span> <span class="n">pow</span><span class="err">）</span>
  <span class="err">✅</span> <span class="err">快速（适合</span> <span class="n">GPU</span><span class="err">）</span>
  <span class="err">✅</span> <span class="err">误差小（</span><span class="o">&lt;</span> <span class="mi">1</span><span class="o">%</span><span class="err">）</span>
  <span class="err">❌</span> <span class="err">不是完全精确</span>
</pre></td> </tr></tbody></table></code></pre></div></div> <h1 id="对于g几何遮挡项的公式的由来和解释">对于G几何遮挡项的公式的由来和解释</h1> <p><strong>D</strong> 项说有微表面朝向 h和高光形状，<strong>F</strong> 项说它们会是否反射，但是因为有许多微平面，它们之间反射肯定会有遮挡关系，那么<strong>G</strong>项就是计算遮挡关系</p> <h2 id="公式smith-ggx-1">公式：Smith-GGX</h2> <p><strong>Height-Correlated Smith-GGX（完整版）：</strong></p> <p>\(G_1(m) = \frac{2(n \cdot m)}{(n \cdot m) + \sqrt{\alpha^2 + (1-\alpha^2)(n \cdot m)^2}}\) <strong>其中：</strong></p> <ul> <li>m = 方向（可以是 v 或 l）</li> <li>α = 粗糙度参数（= roughness²）</li> </ul> <p><strong>因为原公式计算太过复杂所以有了简化公式：</strong> <strong>Christophe Schlick 提出的近似：</strong></p> <p>\(G_1(m) \approx \frac{n \cdot m}{(n \cdot m)(1-k) + k}\) <strong>参数 k 的定义（Schlick 原始）：</strong></p> \[k = \frac{\alpha}{2}\] <p><strong>其中 $\alpha = roughness²$</strong></p> <p><strong>所以：</strong></p> <p>\(k = \frac{\text{roughness}^2}{2}\) <strong>但是Schlick 的 k = α/2 在实际使用中有问题，如果粗糙度是0.5，掠射角看的时候偏亮，暗粗糙度变化不符合直觉</strong> <strong>问题：如果直接用 roughness²也就是α</strong> 当 roughness = 0.5（中等粗糙）时：</p> <div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr>
<td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre></td> <td class="rouge-code"><pre><span class="kt">float</span> <span class="n">k</span> <span class="o">=</span> <span class="n">roughness</span> <span class="o">*</span> <span class="n">roughness</span> <span class="o">/</span> <span class="mi">2</span><span class="p">;</span> <span class="c1">// k = 0.125 </span>
<span class="err">掠射角（</span><span class="n">NoV</span> <span class="o">=</span> <span class="mi">0</span><span class="p">.</span><span class="mi">1</span><span class="err">）：</span> 
<span class="n">G</span><span class="err">₁</span> <span class="o">=</span> <span class="mi">0</span><span class="p">.</span><span class="mi">1</span> <span class="o">/</span> <span class="p">(</span><span class="mi">0</span><span class="p">.</span><span class="mi">1</span> <span class="err">×</span> <span class="mi">0</span><span class="p">.</span><span class="mi">875</span> <span class="o">+</span> <span class="mi">0</span><span class="p">.</span><span class="mi">125</span><span class="p">)</span> <span class="o">=</span> <span class="mi">0</span><span class="p">.</span><span class="mi">47</span> 
</pre></td> </tr></tbody></table></code></pre></div></div> <p><strong>边缘只暗了 53%，看起来不够粗糙，也就是反射还是太过明显</strong></p> <p><strong>Disney 的解决方案（2012）：</strong></p> <p><strong>重新映射 α：</strong></p> \[\alpha_{\text{remapped}} = \frac{\text{roughness} + 1}{2}\] <p><strong>然后：</strong></p> \[k = \frac{\alpha_{\text{remapped}}^2}{2}\] <p><strong>代入：</strong></p> <p>\(k = \frac{\left(\frac{\text{roughness}+1}{2}\right)^2}{2}\) \(= \frac{(\text{roughness}+1)^2}{4 \times 2}\) \(= \frac{(\text{roughness}+1)^2}{8}\) <strong>Disney 的重映射：</strong></p> <div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr>
<td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre></td> <td class="rouge-code"><pre><span class="kt">float</span> <span class="n">k</span> <span class="o">=</span> <span class="p">(</span><span class="n">roughness</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">roughness</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="mi">8</span><span class="p">;</span>  <span class="c1">// k = 0.281</span>

<span class="err">掠射角（</span><span class="n">NoV</span> <span class="o">=</span> <span class="mi">0</span><span class="p">.</span><span class="mi">1</span><span class="err">）：</span>
  <span class="n">G</span><span class="err">₁</span> <span class="o">=</span> <span class="mi">0</span><span class="p">.</span><span class="mi">1</span> <span class="o">/</span> <span class="p">(</span><span class="mi">0</span><span class="p">.</span><span class="mi">1</span> <span class="err">×</span> <span class="mi">0</span><span class="p">.</span><span class="mi">719</span> <span class="o">+</span> <span class="mi">0</span><span class="p">.</span><span class="mi">281</span><span class="p">)</span>
     <span class="o">=</span> <span class="mi">0</span><span class="p">.</span><span class="mi">28</span>
</pre></td> </tr></tbody></table></code></pre></div></div> <p><strong>边缘暗了 72%，符合”中等粗糙”的预期</strong></p> <p><strong>所以k 的计算（直接光照）：</strong></p> <p>\(k = \frac{(\text{roughness} + 1)^2}{8}\) ​<strong>对于环境光K</strong> 直接光（点光源）：</p> <ul> <li>光来自单一方向</li> <li>需要重映射以符合感知</li> <li>k = (α_remapped)² / 2 环境光（IBL）：</li> <li>光来自整个半球</li> <li>已经在预过滤时考虑了分布</li> <li>不需要重映射</li> <li>k = α² / 2（原始 Schlick） <strong>所以环境光K不用变</strong> \(k = \frac{\text{roughness}^2}{2}\) <strong>其中可视性遮蔽：</strong> \(G_1(v) = \frac{n \cdot v}{(n \cdot v) \cdot (1 - k) + k}\)​ <strong>其中光线遮蔽：</strong> \(G_1(l) = \frac{n \cdot l}{(n \cdot l) \cdot (1 - k) + k}\) <strong>那么最终计算结果形式是</strong> \(G(l, v, h) = G_1(l) \cdot G_1(v)\)</li> </ul> <h2 id="最终结果解释">最终结果解释</h2> <p>![[Pasted image 20251227192921.png]] 这里用乘法表示交集意思是<strong>满足光线能照射到</strong>且<strong>可视性遮蔽是可视的</strong> Smith 的核心假设 独立性假设： Shadowing 和 Masking 相互独立 概率论： P(可见) = P(光线不被挡) × P(视线不被挡) = G₁(l) × G₁(v) \(G(l, v, h) = G_1(l) \cdot G_1(v)\)</p> <h1 id="brdf的归一化分母">BRDF的归一化分母</h1> <ol> <li>因子 <strong>4</strong>： 来源：立体角 Jacobian 变换 从微表面法线 h 到入射方向 l\(dω_h = dω_l / [4(v·h)]\)</li> <li>因子 <strong>(n·l)</strong>： 来源：入射投影 光从 l 方向的有效强度 Lambert 余弦定律</li> <li>因子 <strong>(n·v)</strong>： 来源：出射投影 从 v 方向看的有效面积 Foreshortening 效应</li> </ol> <p><strong>(n·l) 和 (n·v)：</strong> 都是<strong>单位向量</strong>的点积 等于夹角的 cos 值 表示投影比例 代表”损失”或”缩减”</p> <h1 id="移动端的优化specularbrdf">移动端的优化SpecularBRDF</h1> <p><strong>标准的GGX高光计算</strong> \(f_{spec}(l, v) = \frac{D(h) \cdot F(v, h) \cdot G(l, v, h)}{4 \cdot (n \cdot l) \cdot (n \cdot v)}\cdot NoL \cdot SpecularColor\) <strong>替换几何项</strong> \(V(l,v,h)=\frac{G(l,v,h)}{4⋅(n⋅l)⋅(n⋅v)}\)<strong>近似</strong>​</p> <p>\(F⋅V≈\frac{1}{LoH_2⋅(roughness+0.5)}\)​</p> <p><strong>最终GGX高光完整公式：</strong></p> <p>\(Specular = D \cdot \frac{1}{LoH^2 \cdot (roughness + 0.5)} \cdot NoL \cdot SpecularColor\) \(D_{GGX}(h) = \frac{\alpha^2}{\pi \left[ (n \cdot h)^2 (\alpha^2 - 1) + 1 \right]^2}\)</p> </div> </article> <br> <hr> <br> <ul class="list-disc pl-8"></ul> <h2 class="text-3xl font-semibold mb-4 mt-12">Enjoy Reading This Article?</h2> <p class="mb-2">Here are some more articles you might like to read next:</p> <li class="my-2"> <a class="text-pink-700 underline font-semibold hover:text-pink-800" href="/blog/2025/GGX_D(H)%E5%88%86%E5%B8%83%E5%8F%AF%E8%A7%86%E5%8C%96/">GGX_D(H)分布可视化</a> </li> <li class="my-2"> <a class="text-pink-700 underline font-semibold hover:text-pink-800" href="/blog/2025/Lv.2-Unity%E4%B8%BB%E7%BA%BF-%E6%B7%BB%E5%8A%A0%E7%8E%AF%E5%A2%83%E5%85%89/">Lv.2 Unity主线：添加环境光</a> </li> <li class="my-2"> <a class="text-pink-700 underline font-semibold hover:text-pink-800" href="/blog/2025/Lv.2-Unity%E4%B8%BB%E7%BA%BF-%E6%B7%BB%E5%8A%A0%E5%A4%9A%E5%85%89%E6%BA%90%E4%BA%A4%E4%BA%92/">Lv.2 Unity主线：添加多光源交互</a> </li> <li class="my-2"> <a class="text-pink-700 underline font-semibold hover:text-pink-800" href="/blog/2025/Lv.2-Unity%E4%B8%BB%E7%BA%BF-%E9%95%9C%E9%9D%A2%E5%8F%8D%E5%B0%84%E5%85%89%E7%85%A7%E6%A8%A1%E5%9E%8BPhong%E5%92%8CBlinn-Phong/">镜面反射光照模型Phong和Blinn-Phong</a> </li> <li class="my-2"> <a class="text-pink-700 underline font-semibold hover:text-pink-800" href="/blog/2025/Lv.2-Unity%E4%B8%BB%E7%BA%BF-%E6%B7%BB%E5%8A%A0%E6%B3%95%E7%BA%BF/">Lv.2 Unity主线：添加法线</a> </li> </div> # # <script>
# (function() {
#   'use strict';
  
#   document.addEventListener('DOMContentLoaded', function() {
#     // 检查 Medium Zoom 是否可用
#     if (typeof mediumZoom !== 'undefined') {
#       // 使用 Medium Zoom
#       mediumZoom('.post-content img:not([width]):not([style])', {
#         margin: 24,
#         background: 'rgba(0, 0, 0, 0.9)',
#         scrollOffset: 0
#       });
#       console.log('Medium Zoom enabled');
#     } else {
#       // 如果没有 Medium Zoom，手动添加点击事件
#       const images = document.querySelectorAll('.post-content img:not([width]):not([style])');
#       images.forEach(function(img) {
#         img.style.cursor = 'zoom-in';
#         img.addEventListener('click', function() {
#           // 简单的全屏显示
#           const overlay = document.createElement('div');
#           overlay.style.cssText = 'position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.9);z-index:9999;display:flex;align-items:center;justify-content:center;cursor:zoom-out;';
          
#           const enlargedImg = document.createElement('img');
#           enlargedImg.src = this.src;
#           enlargedImg.style.cssText = 'max-width:90%;max-height:90%;object-fit:contain;';
          
#           overlay.appendChild(enlargedImg);
#           document.body.appendChild(overlay);
          
#           overlay.addEventListener('click', function() {
#             document.body.removeChild(overlay);
#           });
#         });
#       });
#       console.log('Manual zoom enabled for', images.length, 'images');
#     }
#   });
# })();
# </script> <script>
(function() {
  'use strict';
  
  document.addEventListener('DOMContentLoaded', function() {
    
    
    const selector = '.post-content img:not([width]):not([style]):not([data-spotlight-converted])';
    const images = document.querySelectorAll(selector);
    
    if (images.length === 0) {
      console.log('Spotlight: No images to convert');
      return;
    }
    
    images.forEach(function(img) {
      if (img.parentElement.classList.contains('spotlight')) {
        return;
      }
      
      const link = document.createElement('a');
      link.className = 'spotlight';
      link.href = img.src;
      
      if (img.alt) {
        link.setAttribute('data-description', img.alt);
      }
      
      img.setAttribute('data-spotlight-converted', 'true');
      
      // 强制设置样式（防止被覆盖）
      img.style.cssText = 'max-width: 75% !important; display: block !important; margin: 1em auto !important; cursor: zoom-in !important;';
      
      const parent = img.parentNode;
      parent.insertBefore(link, img);
      link.appendChild(img);
    });
    
    console.log('Spotlight: Converted', images.length, 'images');
    
    
  });
})();
</script> </div> </div> </div> <footer class="fixed-bottom" role="contentinfo"> <div class="container mt-0"> © Copyright 2025 吟处雪 轻遮. Powered by <a href="https://jekyllrb.com/" target="_blank" rel="external nofollow noopener">Jekyll</a> with <a href="https://github.com/alshedivat/al-folio" target="_blank" rel="external nofollow noopener">al-folio</a> theme. Hosted by <a href="https://pages.github.com/" target="_blank" rel="external nofollow noopener">GitHub Pages</a>. </div> </footer> <script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js" integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script> <script src="/assets/js/bootstrap.bundle.min.js"></script> <script src="https://cdn.jsdelivr.net/npm/mdbootstrap@4.20.0/js/mdb.min.js" integrity="sha256-NdbiivsvWt7VYCt6hYNT3h/th9vSTL4EDWeGs5SN3DA=" crossorigin="anonymous"></script> <script defer src="https://cdn.jsdelivr.net/npm/masonry-layout@4.2.2/dist/masonry.pkgd.min.js" integrity="sha256-Nn1q/fx0H7SNLZMQ5Hw5JLaTRZp0yILA/FRexe19VdI=" crossorigin="anonymous"></script> <script defer src="https://cdn.jsdelivr.net/npm/imagesloaded@5.0.0/imagesloaded.pkgd.min.js" integrity="sha256-htrLFfZJ6v5udOG+3kNLINIKh2gvoKqwEhHYfTTMICc=" crossorigin="anonymous"></script> <script defer src="/assets/js/masonry.js?a0db7e5d5c70cc3252b3138b0c91dcaf" type="text/javascript"></script> <script defer src="https://cdn.jsdelivr.net/npm/medium-zoom@1.1.0/dist/medium-zoom.min.js" integrity="sha256-ZgMyDAIYDYGxbcpJcfUnYwNevG/xi9OHKaR/8GK+jWc=" crossorigin="anonymous"></script> <script defer src="/assets/js/zoom.js?85ddb88934d28b74e78031fd54cf8308"></script> <script defer src="/assets/js/bootstrap-toc.min.js?c82ff4de8b0955d6ff14f5b05eed7eb6"></script> <script src="/assets/js/no_defer.js?2781658a0a2b13ed609542042a859126"></script> <script defer src="/assets/js/common.js?c15de51d4bb57887caa2c21988d97279"></script> <script defer src="/assets/js/copy_code.js?c8a01c11a92744d44b093fc3bda915df" type="text/javascript"></script> <script defer src="/assets/js/jupyter_new_tab.js?d9f17b6adc2311cbabd747f4538bb15f"></script> <script async src="https://d1bxh8uas1mnw7.cloudfront.net/assets/embed.js"></script> <script async src="https://badge.dimensions.ai/badge.js"></script> <script defer type="text/javascript" id="MathJax-script" src="https://cdn.jsdelivr.net/npm/mathjax@3.2.2/es5/tex-mml-chtml.js" integrity="sha256-MASABpB4tYktI2Oitl4t+78w/lyA+D7b/s9GEP0JOGI=" crossorigin="anonymous"></script> <script src="/assets/js/mathjax-setup.js?a5bb4e6a542c546dd929b24b8b236dfd"></script> <script defer src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?features=es6" crossorigin="anonymous"></script> <script defer src="/assets/js/progress-bar.js?2f30e0e6801ea8f5036fa66e1ab0a71a" type="text/javascript"></script> <script defer src="https://cdn.jsdelivr.net/npm/spotlight.js@0.7.8/dist/spotlight.bundle.min.js" crossorigin="anonymous"></script> <script src="/assets/js/vanilla-back-to-top.min.js?f40d453793ff4f64e238e420181a1d17"></script> <script>
    addBackToTop();
  </script> <script type="module" src="/assets/js/search/ninja-keys.min.js?a3446f084dcaecc5f75aa1757d087dcf"></script> <ninja-keys hidebreadcrumbs noautoloadmdicons placeholder="Type to start searching"></ninja-keys> <script src="/assets/js/search-setup.js?6c304f7b1992d4b60f7a07956e52f04a"></script> <script src="/assets/js/search-data.js"></script> <script src="/assets/js/shortcut-key.js?6f508d74becd347268a7f822bca7309d"></script> </body> </html>