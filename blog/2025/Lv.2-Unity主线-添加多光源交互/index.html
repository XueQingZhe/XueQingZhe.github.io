<!DOCTYPE html> <html lang="zh-CN"> <head> <meta http-equiv="Content-Type" content="text/html; charset=UTF-8"> <meta charset="utf-8"> <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"> <meta http-equiv="X-UA-Compatible" content="IE=edge"> <title> Lv.2 Unity主线：添加多光源交互 | 吟处雪 轻遮 </title> <meta name="author" content="吟处雪 轻遮"> <meta name="description" content="如何多光源交互"> <meta name="keywords" content="technical-artist, shader, rendering, unity, unreal-engine, pbr, toon-shading"> <link rel="stylesheet" href="/assets/css/bootstrap.min.css?a4b3f509e79c54a512b890d73235ef04"> <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/mdbootstrap@4.20.0/css/mdb.min.css" integrity="sha256-jpjYvU3G3N6nrrBwXJoVEYI/0zw8htfFnhT9ljN3JJw=" crossorigin="anonymous"> <link defer rel="stylesheet" href="/assets/css/academicons.min.css?f0b7046b84e425c55f3463ac249818f5"> <link defer rel="stylesheet" href="/assets/css/scholar-icons.css?62b2ac103a88034e6882a5be5f3e2772"> <link defer rel="stylesheet" type="text/css" href="https://fonts.googleapis.com/css?family=Roboto:300,400,500,700|Roboto+Slab:100,300,400,500,700|Material+Icons&amp;display=swap"> <link defer rel="stylesheet" href="/assets/css/jekyll-pygments-themes-github.css?591dab5a4e56573bf4ef7fd332894c99" media="" id="highlight_theme_light"> <link defer href="/assets/css/bootstrap-toc.min.css?6f5af0bb9aab25d79b2448143cbeaa88" rel="stylesheet"> <link rel="shortcut icon" href="data:image/svg+xml,&lt;svg%20xmlns=%22http://www.w3.org/2000/svg%22%20viewBox=%220%200%20100%20100%22&gt;&lt;text%20y=%22.9em%22%20font-size=%2290%22&gt;%E2%9A%9B%EF%B8%8F&lt;/text&gt;&lt;/svg&gt;"> <link rel="stylesheet" href="/assets/css/main.css?d41d8cd98f00b204e9800998ecf8427e"> <link rel="canonical" href="https://xueqingzhe.github.io/blog/2025/Lv.2-Unity%E4%B8%BB%E7%BA%BF-%E6%B7%BB%E5%8A%A0%E5%A4%9A%E5%85%89%E6%BA%90%E4%BA%A4%E4%BA%92/"> <script src="/assets/js/theme.js?a81d82887dd692e91686b43de4542f18"></script> <link defer rel="stylesheet" href="/assets/css/jekyll-pygments-themes-native.css?5847e5ed4a4568527aa6cfab446049ca" media="none" id="highlight_theme_dark"> <script>
    initTheme();
  </script> <link defer rel="stylesheet" href="https://cdn.jsdelivr.net/npm/spotlight.js@0.7.8/dist/css/spotlight.min.css" integrity="sha256-Dsvkx8BU8ntk9Iv+4sCkgHRynYSQQFP6gJfBN5STFLY=" crossorigin="anonymous"> </head> <body class="fixed-top-nav "> <header> <nav id="navbar" class="navbar navbar-light navbar-expand-sm fixed-top" role="navigation"> <div class="container"> <a class="navbar-brand title font-weight-lighter" href="/"> <span class="font-weight-bold">吟处雪</span> 轻遮 </a> <button class="navbar-toggler collapsed ml-auto" type="button" data-toggle="collapse" data-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation"> <span class="sr-only">Toggle navigation</span> <span class="icon-bar top-bar"></span> <span class="icon-bar middle-bar"></span> <span class="icon-bar bottom-bar"></span> </button> <div class="collapse navbar-collapse text-right" id="navbarNav"> <ul class="navbar-nav ml-auto flex-nowrap"> <li class="nav-item "> <a class="nav-link" href="/">about </a> </li> <li class="nav-item active"> <a class="nav-link" href="/blog/">blog </a> </li> <li class="nav-item "> <a class="nav-link" href="/projects/">projects </a> </li> <li class="nav-item "> <a class="nav-link" href="/books/">books </a> </li> <li class="nav-item "> <a class="nav-link" href="/tutorials/">tutorials </a> </li> <li class="nav-item"> <button id="search-toggle" title="Search" onclick="openSearchModal()"> <span class="nav-link">ctrl k <i class="ti ti-search"></i></span> </button> </li> <li class="toggle-container"> <button id="light-toggle" title="Change theme"> <i class="ti ti-sun-moon" id="light-toggle-system"></i> <i class="ti ti-moon-filled" id="light-toggle-dark"></i> <i class="ti ti-sun-filled" id="light-toggle-light"></i> </button> </li> </ul> </div> </div> </nav> <progress id="progress" value="0"> <div class="progress-container"> <span class="progress-bar"></span> </div> </progress> </header> <div class="container mt-5" role="main"> <div class="row"> <div class="col-sm-3"> <nav id="toc-sidebar" class="sticky-top"></nav> </div> <div class="col-sm-9"> <div class="post"> <header class="post-header"> <h1 class="post-title">Lv.2 Unity主线：添加多光源交互</h1> <p class="post-meta"> Created on December 21, 2025 </p> <p class="post-tags"> <a href="/blog/2025"> <i class="fa-solid fa-calendar fa-sm"></i> 2025 </a>   ·   <a href="/blog/tag/shader"> <i class="fa-solid fa-hashtag fa-sm"></i> shader</a>   <a href="/blog/tag/rendering"> <i class="fa-solid fa-hashtag fa-sm"></i> rendering</a>   <a href="/blog/tag/unity"> <i class="fa-solid fa-hashtag fa-sm"></i> unity</a>   ·   <a href="/blog/category/tamonth01"> <i class="fa-solid fa-tag fa-sm"></i> TAMonth01</a> </p> </header> <article class="post-content"> <div id="markdown-content"> <h1 id="前向渲染多光源必要代码">前向渲染多光源必要代码</h1> <h1 id="shader-pass">Shader Pass</h1> <p><strong>一般是单Pass，也就是ForwardPass，进行处理主光源（平行光），多光源设置实际上就是添加一个新的Pass处理点光和射光，注意不包括面光。这个Pass就是ForwardAddPass</strong></p> <h2 id="结构体的声明要求">结构体的声明要求</h2> <p><strong><em>顶点的命名必须固定为vertex和pos</em></strong> <img src="/assets/img/TAMonth01/Pasted%20image%2020251210193256.png" alt="图片"> <strong><em>原函数在生成平行光的阴影时不会访问物体空间顶点位置，因为平行光不会衰减而且单一方向，所以它直接使用裁剪空间下的位置计算出阴影图，但是对于点光，因为点光是一个球型范围衰减，它需要生成一个cubemap阴影图，所以需要使用顶点位置信息，因为通常情况是顶点数比片元更少，所以使用物体空间的顶点位置vertex进行矩阵变换到点光源空间计算得到cubemap阴影图。</em></strong> <img src="/assets/img/TAMonth01/Pasted%20image%2020251210193016.png" alt="图片"></p> <h2 id="forwardpass">ForwardPass</h2> <h3 id="tags">Tags</h3> <div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr>
<td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre></td> <td class="rouge-code"><pre><span class="n">Name</span> <span class="s">"Forward"</span>
<span class="n">Tags</span>
<span class="p">{</span>
    <span class="s">"LightMode"</span> <span class="o">=</span> <span class="s">"ForwardBase"</span>
<span class="p">}</span>
</pre></td> </tr></tbody></table></code></pre></div></div> <h3 id="pragma指令">pragma指令</h3> <div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr>
<td class="rouge-gutter gl"><pre class="lineno">1
</pre></td> <td class="rouge-code"><pre><span class="cp">#pragma multi_compile_fwdbase
</span></pre></td> </tr></tbody></table></code></pre></div></div> <h3 id="include">include</h3> <div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr>
<td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre></td> <td class="rouge-code"><pre><span class="cp">#include</span> <span class="cpf">"UnityCG.cginc"</span><span class="cp">
#include</span> <span class="cpf">"Lighting.cginc"</span><span class="cp">
#include</span> <span class="cpf">"AutoLight.cginc"</span><span class="c1">            </span><span class="cp">
</span></pre></td> </tr></tbody></table></code></pre></div></div> <h3 id="阴影和光照衰减函数">阴影和光照衰减函数</h3> <p><strong><em>对于ForwardBasePass处理阴影的时候是使用SHADOW_ATTENUATION(i)，多光源投射的阴影是另外的函数</em></strong></p> <div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr>
<td class="rouge-gutter gl"><pre class="lineno">1
2
</pre></td> <td class="rouge-code"><pre><span class="c1">// 计算阴影衰减（自动处理所有阴影类型）</span>
<span class="n">fixed</span> <span class="n">shadow</span> <span class="o">=</span> <span class="n">SHADOW_ATTENUATION</span><span class="p">(</span><span class="n">i</span><span class="p">);</span>
</pre></td> </tr></tbody></table></code></pre></div></div> <h2 id="forwardaddpass">ForwardAddPass</h2> <p><strong>处理ForwardAddPass，可以直接将原Pass进行拷贝就行，大部分是一样的</strong>*</p> <h3 id="tags-1">Tags</h3> <div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr>
<td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre></td> <td class="rouge-code"><pre><span class="n">Name</span><span class="s">"ForwadAdd"</span>
<span class="n">Tags</span>
<span class="p">{</span>
    <span class="s">"LightMode"</span> <span class="o">=</span> <span class="s">"ForwardAdd"</span>
<span class="p">}</span>
</pre></td> </tr></tbody></table></code></pre></div></div> <h3 id="pragma指令-1">pragma指令</h3> <p><strong>这里多光源的指令有两条，按需使用</strong></p> <div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr>
<td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre></td> <td class="rouge-code"><pre><span class="c1">// 无阴影仅光源衰减需要的变体</span>
<span class="cp">#pragma multi_compile_fwdadd
</span><span class="c1">// 使用带阴影的编译指令</span>
<span class="cp">#pragma multi_compile_fwdadd_fullshadows
</span></pre></td> </tr></tbody></table></code></pre></div></div> <p><strong><em>带阴影指令实际上是给这里使用的，也就是点光的照射阴影，如果不使用fullshadows那么怎么调都是没有的</em></strong> <img src="/assets/img/TAMonth01/Pasted%20image%2020251210192136.png" alt="图片"> <strong><em>相当于额外的光照阴影</em></strong></p> <h3 id="关键字">关键字</h3> <p><strong><em>光照叠加使用加法混合</em></strong></p> <div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr>
<td class="rouge-gutter gl"><pre class="lineno">1
2
</pre></td> <td class="rouge-code"><pre><span class="n">Blend</span> <span class="n">One</span> <span class="n">One</span>  <span class="c1">// 加法混合是关键</span>
<span class="n">ZWrite</span> <span class="n">Off</span>     <span class="c1">// 避免深度冲突</span>
</pre></td> </tr></tbody></table></code></pre></div></div> <h3 id="光源判断">光源判断</h3> <p><strong><em>使用宏判断</em></strong></p> <div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr>
<td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre></td> <td class="rouge-code"><pre> <span class="c1">// 关键：附加光源的方向计算</span>
<span class="cp">#ifdef USING_DIRECTIONAL_LIGHT
</span>    <span class="n">float3</span> <span class="n">lightDir</span> <span class="o">=</span> <span class="n">normalize</span><span class="p">(</span><span class="n">_WorldSpaceLightPos0</span><span class="p">.</span><span class="n">xyz</span><span class="p">);</span>
<span class="cp">#else
</span>    <span class="n">float3</span> <span class="n">lightDir</span> <span class="o">=</span> <span class="n">normalize</span><span class="p">(</span><span class="n">_WorldSpaceLightPos0</span><span class="p">.</span><span class="n">xyz</span> <span class="o">-</span> <span class="n">i</span><span class="p">.</span><span class="n">posWS</span><span class="p">);</span>
<span class="cp">#endif
</span></pre></td> </tr></tbody></table></code></pre></div></div> <p><strong><em>_WorldSpaceLightPos0.w灯光标记判断，0是平行光，1是非平行光</em></strong></p> <div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr>
<td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre></td> <td class="rouge-code"><pre><span class="c1">//平行光源向量</span>
<span class="n">half3</span> <span class="n">light_dir</span> <span class="o">=</span> <span class="n">normalize</span><span class="p">(</span><span class="n">_WorldSpaceLightPos0</span><span class="p">.</span><span class="n">xyz</span><span class="p">);</span>
<span class="c1">//点光源向量</span>
<span class="n">half3</span> <span class="n">light_dir_point</span> <span class="o">=</span> <span class="n">normalize</span><span class="p">(</span><span class="n">_WorldSpaceLightPos0</span><span class="p">.</span><span class="n">xyz</span> <span class="o">-</span> <span class="n">i</span><span class="p">.</span><span class="n">pos_world</span><span class="p">);</span>   
<span class="c1">//_WorldSpaceLightPos0.w可以判断光源类型</span>
<span class="n">light_dir</span> <span class="o">=</span> <span class="n">lerp</span><span class="p">(</span><span class="n">light_dir</span><span class="p">,</span> <span class="n">light_dir_point</span><span class="p">,</span> <span class="n">_WorldSpaceLightPos0</span><span class="p">.</span><span class="n">w</span><span class="p">);</span> 
</pre></td> </tr></tbody></table></code></pre></div></div> <p><strong><em>如果想要手动控制衰减，可以判断分类即可，一般不推荐</em></strong></p> <div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr>
<td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
</pre></td> <td class="rouge-code"><pre><span class="cp">#if defined (DIRECTIONAL)
</span><span class="n">half3</span> <span class="n">light_dir</span> <span class="o">=</span> <span class="n">normalize</span><span class="p">(</span><span class="n">_WorldSpaceLightPos0</span><span class="p">.</span><span class="n">xyz</span><span class="p">);</span>   <span class="c1">//主光源向量</span>
<span class="n">half</span> <span class="n">attuenation</span> <span class="o">=</span> <span class="mi">1</span><span class="p">.</span><span class="mi">0</span><span class="p">;</span>
<span class="cp">#elif defined (POINT)
</span><span class="n">half3</span> <span class="n">light_dir</span> <span class="o">=</span> <span class="n">normalize</span><span class="p">(</span><span class="n">_WorldSpaceLightPos0</span><span class="p">.</span><span class="n">xyz</span> <span class="o">-</span> <span class="n">i</span><span class="p">.</span><span class="n">pos_world</span><span class="p">);</span>   <span class="c1">//主光源向量</span>
<span class="n">half</span> <span class="n">distance</span> <span class="o">=</span> <span class="n">length</span><span class="p">(</span><span class="n">_WorldSpaceLightPos0</span><span class="p">.</span><span class="n">xyz</span> <span class="o">-</span> <span class="n">i</span><span class="p">.</span><span class="n">pos_world</span><span class="p">);</span>
<span class="n">half</span> <span class="n">range</span> <span class="o">=</span> <span class="mi">1</span><span class="p">.</span><span class="mi">0</span> <span class="o">/</span> <span class="n">unity_WorldToLight</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">];</span><span class="c1">//获取点光源的range属性</span>
<span class="n">half</span> <span class="n">attuenation</span> <span class="o">=</span> <span class="n">saturate</span><span class="p">((</span><span class="n">range</span> <span class="o">-</span> <span class="n">distance</span><span class="p">)</span><span class="o">/</span><span class="n">range</span><span class="p">);</span><span class="c1">//光照衰减系数，平行光无衰减</span>
<span class="cp">#endif
</span></pre></td> </tr></tbody></table></code></pre></div></div> <h3 id="阴影和光照衰减函数-1">阴影和光照衰减函数</h3> <div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr>
<td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre></td> <td class="rouge-code"><pre><span class="c1">// 阴影和衰减 atten是创建接收的变量，i是指输入的v2f结构</span>
<span class="n">UNITY_LIGHT_ATTENUATION</span><span class="p">(</span><span class="n">atten</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">i</span><span class="p">.</span><span class="n">posWS</span><span class="p">);</span>
<span class="c1">//atten不需要声明，直接乘法混合就行</span>
<span class="n">fixed3</span> <span class="n">finalCol</span> <span class="o">=</span> <span class="n">col</span><span class="p">.</span><span class="n">rgb</span> <span class="o">*</span> <span class="n">nol</span> <span class="o">*</span> <span class="n">atten</span> <span class="o">*</span> <span class="n">_LightColor0</span><span class="p">.</span><span class="n">rgb</span><span class="p">;</span>
</pre></td> </tr></tbody></table></code></pre></div></div> <h1 id="前向渲染和延迟渲染的光源数量和渲染处理">前向渲染和延迟渲染的光源数量和渲染处理</h1> <h2 id="前向渲染灯光处理">前向渲染灯光处理</h2> <p><strong>这里我在场景中加了很多光源，材质就是默认的standard材质</strong> <img src="/assets/img/TAMonth01/Pasted%20image%2020251212191952.png" alt="图片"></p> <h3 id="framedebuger">FrameDebuger</h3> <p><strong>使用FrameDebuger可以看到每个光源对于每个物体Mesh都需要单独计算渲染一次，那么理所当然光源越多，消耗越大，灯光数量需要进行严格的控制，对于大场景自然不能使用前向渲染</strong> <img src="/assets/img/TAMonth01/%E5%89%8D%E5%90%91%E6%B8%B2%E6%9F%93%E5%A4%9A%E5%85%89%E6%BA%90%201.gif" alt="图片"> <strong>同时当灯光超过规定数量时，会自动降级为顶点灯光，也就是不在片元计算，像素一般来说是比顶点多的多的，所以顶点光照质量就会非常差</strong> <img src="/assets/img/TAMonth01/Pasted%20image%2020251212192957.png" alt="图片"></p> <h2 id="延迟渲染灯光处理">延迟渲染灯光处理</h2> <h3 id="开启延迟渲染">开启延迟渲染</h3> <p><strong>找到MainCamera里面的渲染设置更改为Deferred</strong> <img src="/assets/img/TAMonth01/Pasted%20image%2020251212193424.png" alt="图片"></p> <h3 id="framedebuger-1">FrameDebuger</h3> <p><strong>延迟渲染下，因为是先统一输出Guffer，然后再统一计算，所以可以看出绘制数明显降低，相当于把物体合批在绘制灯光了</strong> <img src="/assets/img/TAMonth01/%E5%BB%B6%E8%BF%9F%E6%B8%B2%E6%9F%93%E5%A4%9A%E5%85%89%E6%BA%90.gif" alt="图片"></p> <h1 id="延迟渲染必要代码">延迟渲染必要代码</h1> <p><strong>延迟渲染是灯光都在一个Pass中处理</strong></p> <h2 id="tags-2">Tags</h2> <div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr>
<td class="rouge-gutter gl"><pre class="lineno">1
</pre></td> <td class="rouge-code"><pre><span class="n">Tags</span> <span class="p">{</span> <span class="s">"LightMode"</span> <span class="o">=</span> <span class="s">"Deferred"</span> <span class="p">}</span>
</pre></td> </tr></tbody></table></code></pre></div></div> <h2 id="pragma">pragma</h2> <div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr>
<td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre></td> <td class="rouge-code"><pre><span class="cp">#pragma exclude_renderers nomrt
</span>
<span class="c1">// 意思是：</span>
<span class="c1">// "排除那些不支持MRT的渲染器（平台）"</span>
<span class="c1">// 也就是：只在支持MRT的平台上编译和运行这个Shader</span>
</pre></td> </tr></tbody></table></code></pre></div></div> <h2 id="额外的输出结构体">额外的输出结构体</h2> <p><strong>将需要输出的内容分别输出，最多8个，一般输出4个</strong>*</p> <div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr>
<td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre></td> <td class="rouge-code"><pre><span class="k">struct</span> <span class="n">GBuffer</span>
            <span class="p">{</span>
                <span class="n">half4</span> <span class="n">diffuse</span> <span class="o">:</span> <span class="n">SV_Target0</span><span class="p">;</span>
                <span class="n">half4</span> <span class="n">spec</span> <span class="o">:</span> <span class="n">SV_Target1</span><span class="p">;</span>
                <span class="n">half4</span> <span class="n">normal</span> <span class="o">:</span> <span class="n">SV_Target2</span><span class="p">;</span>
                <span class="n">half4</span> <span class="n">emission</span> <span class="o">:</span> <span class="n">SV_Target3</span><span class="p">;</span>
            <span class="p">};</span>
</pre></td> </tr></tbody></table></code></pre></div></div> <h2 id="片元着色器">片元着色器</h2> <p><strong>不需要计算光照，直接将对应数据输出就行，同时frag函数后面不需要加SV_Target</strong> <img src="/assets/img/TAMonth01/Pasted%20image%2020251212200035.png" alt="图片"></p> <h1 id="代码参考">代码参考</h1> <p><strong>为了方便两种切换，所以就直接加上延迟渲染Pass了</strong></p> <div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr>
<td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
156
157
158
159
160
161
162
163
164
165
166
167
168
169
170
171
172
173
174
175
176
177
178
179
180
181
182
183
184
185
186
187
188
189
190
191
192
193
194
195
196
197
198
199
200
201
202
203
204
205
206
207
208
209
210
211
212
213
214
215
216
217
218
219
220
221
222
223
224
225
226
227
228
229
230
231
232
233
234
235
236
237
238
239
240
241
242
243
244
245
246
247
248
249
250
251
252
253
254
255
256
257
258
259
260
261
262
263
264
265
266
267
268
269
270
271
272
273
274
275
276
277
278
279
280
281
282
283
284
285
286
287
288
289
290
291
292
293
294
295
296
297
298
</pre></td> <td class="rouge-code"><pre><span class="n">Shader</span> <span class="s">"Unlit/AddLight_Deferred"</span>

<span class="p">{</span>

    <span class="n">Properties</span>
    <span class="p">{</span>
        <span class="n">_MainTex</span> <span class="p">(</span><span class="s">"Texture"</span><span class="p">,</span> <span class="mi">2</span><span class="n">D</span><span class="p">)</span> <span class="o">=</span> <span class="s">"white"</span> <span class="p">{}</span>

    <span class="p">}</span>
    <span class="n">SubShader</span>
    <span class="p">{</span>
        <span class="n">Tags</span> <span class="p">{</span> <span class="s">"RenderType"</span><span class="o">=</span><span class="s">"Opaque"</span> <span class="p">}</span>
        <span class="n">LOD</span> <span class="mi">100</span>
        <span class="n">CGINCLUDE</span>
        <span class="cp">#include</span> <span class="cpf">"UnityCG.cginc"</span><span class="cp">
</span>        <span class="n">sampler2D</span> <span class="n">_MainTex</span><span class="p">;</span>
        <span class="n">float4</span> <span class="n">_MainTex_ST</span><span class="p">;</span>
        <span class="n">ENDCG</span>
        <span class="n">Pass</span>
        <span class="p">{</span>
            <span class="n">Name</span> <span class="s">"Deferred"</span>
            <span class="n">Tags</span> <span class="p">{</span> <span class="s">"LightMode"</span> <span class="o">=</span> <span class="s">"Deferred"</span> <span class="p">}</span>
            <span class="n">CGPROGRAM</span>
            <span class="cp">#pragma vertex vert
</span>            <span class="cp">#pragma fragment frag
</span>            <span class="cp">#pragma exclude_renderers nomrt
</span>            <span class="cp">#pragma target 3.0
</span>            <span class="cp">#include</span> <span class="cpf">"UnityCG.cginc"</span><span class="cp">
</span>
            <span class="k">struct</span> <span class="n">appdata</span>

            <span class="p">{</span>
                <span class="n">float4</span> <span class="n">vertex</span> <span class="o">:</span> <span class="n">POSITION</span><span class="p">;</span>
                <span class="n">float2</span> <span class="n">uv</span> <span class="o">:</span> <span class="n">TEXCOORD0</span><span class="p">;</span>
                <span class="n">float3</span> <span class="n">normal</span> <span class="o">:</span> <span class="n">NORMAL</span><span class="p">;</span>
            <span class="p">};</span>

            <span class="k">struct</span> <span class="n">v2f</span>
            <span class="p">{</span>
                <span class="n">float4</span> <span class="n">pos</span> <span class="o">:</span> <span class="n">SV_POSITION</span><span class="p">;</span>
                <span class="n">float2</span> <span class="n">uv</span> <span class="o">:</span> <span class="n">TEXCOORD0</span><span class="p">;</span>
                <span class="n">float3</span> <span class="n">normalWS</span> <span class="o">:</span> <span class="n">TEXCOORD1</span><span class="p">;</span>
            <span class="p">};</span>

            <span class="k">struct</span> <span class="n">GBuffer</span>
            <span class="p">{</span>
                <span class="n">half4</span> <span class="n">diffuse</span> <span class="o">:</span> <span class="n">SV_Target0</span><span class="p">;</span>
                <span class="n">half4</span> <span class="n">spec</span> <span class="o">:</span> <span class="n">SV_Target1</span><span class="p">;</span>
                <span class="n">half4</span> <span class="n">normal</span> <span class="o">:</span> <span class="n">SV_Target2</span><span class="p">;</span>
                <span class="n">half4</span> <span class="n">emission</span> <span class="o">:</span> <span class="n">SV_Target3</span><span class="p">;</span>
            <span class="p">};</span>

            <span class="n">v2f</span> <span class="n">vert</span><span class="p">(</span><span class="n">appdata</span> <span class="n">v</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="n">v2f</span> <span class="n">o</span><span class="p">;</span>
                <span class="n">o</span><span class="p">.</span><span class="n">pos</span> <span class="o">=</span> <span class="n">UnityObjectToClipPos</span><span class="p">(</span><span class="n">v</span><span class="p">.</span><span class="n">vertex</span><span class="p">);</span>
                <span class="n">o</span><span class="p">.</span><span class="n">uv</span> <span class="o">=</span> <span class="n">TRANSFORM_TEX</span><span class="p">(</span><span class="n">v</span><span class="p">.</span><span class="n">uv</span><span class="p">,</span> <span class="n">_MainTex</span><span class="p">);</span>
                <span class="n">o</span><span class="p">.</span><span class="n">normalWS</span> <span class="o">=</span> <span class="n">UnityObjectToWorldNormal</span><span class="p">(</span><span class="n">v</span><span class="p">.</span><span class="n">normal</span><span class="p">);</span>
                <span class="k">return</span> <span class="n">o</span><span class="p">;</span>
            <span class="p">}</span>

            <span class="n">GBuffer</span> <span class="n">frag</span><span class="p">(</span><span class="n">v2f</span> <span class="n">i</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="n">fixed4</span> <span class="n">albedo</span> <span class="o">=</span> <span class="n">tex2D</span><span class="p">(</span><span class="n">_MainTex</span><span class="p">,</span> <span class="n">i</span><span class="p">.</span><span class="n">uv</span><span class="p">);</span>
                <span class="n">float3</span> <span class="n">normalWS</span> <span class="o">=</span> <span class="n">normalize</span><span class="p">(</span><span class="n">i</span><span class="p">.</span><span class="n">normalWS</span><span class="p">);</span>

                <span class="n">GBuffer</span> <span class="n">output</span><span class="p">;</span>
                <span class="n">output</span><span class="p">.</span><span class="n">diffuse</span> <span class="o">=</span> <span class="n">half4</span><span class="p">(</span><span class="n">albedo</span><span class="p">.</span><span class="n">rgb</span><span class="p">,</span> <span class="mi">1</span><span class="p">.</span><span class="mi">0</span><span class="p">);</span>
                <span class="n">output</span><span class="p">.</span><span class="n">spec</span> <span class="o">=</span> <span class="n">half4</span><span class="p">(</span><span class="mi">0</span><span class="p">.</span><span class="mo">04</span><span class="p">,</span> <span class="mi">0</span><span class="p">.</span><span class="mo">04</span><span class="p">,</span> <span class="mi">0</span><span class="p">.</span><span class="mo">04</span><span class="p">,</span> <span class="mi">0</span><span class="p">.</span><span class="mi">5</span><span class="p">);</span>
                <span class="n">output</span><span class="p">.</span><span class="n">normal</span> <span class="o">=</span> <span class="n">half4</span><span class="p">(</span><span class="n">normalWS</span> <span class="o">*</span> <span class="mi">0</span><span class="p">.</span><span class="mi">5</span> <span class="o">+</span> <span class="mi">0</span><span class="p">.</span><span class="mi">5</span><span class="p">,</span> <span class="mi">1</span><span class="p">.</span><span class="mi">0</span><span class="p">);</span>
                <span class="n">output</span><span class="p">.</span><span class="n">emission</span> <span class="o">=</span> <span class="n">half4</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
                <span class="k">return</span> <span class="n">output</span><span class="p">;</span>
            <span class="p">}</span>
            <span class="n">ENDCG</span>

        <span class="p">}</span>

        <span class="n">Pass</span>
        <span class="p">{</span>
           <span class="n">Name</span> <span class="s">"Forward"</span>
           <span class="n">Tags</span><span class="p">{</span>
            <span class="s">"LightMode"</span> <span class="o">=</span> <span class="s">"ForwardBase"</span>
           <span class="p">}</span>

            <span class="n">CGPROGRAM</span>
            <span class="cp">#pragma vertex vert
</span>            <span class="cp">#pragma fragment frag
</span>            <span class="c1">// make fog work</span>
            <span class="cp">#pragma multi_compile_fwdbase
</span>
            <span class="cp">#include</span> <span class="cpf">"UnityCG.cginc"</span><span class="cp">
</span>            <span class="cp">#include</span> <span class="cpf">"Lighting.cginc"</span><span class="cp">
</span>            <span class="cp">#include</span> <span class="cpf">"AutoLight.cginc"</span><span class="c1">             // 阴影宏定义在这里</span><span class="cp">
</span>
            <span class="k">struct</span> <span class="n">appdata</span>
            <span class="p">{</span>
                <span class="n">float4</span> <span class="n">vertex</span>   <span class="o">:</span> <span class="n">POSITION</span><span class="p">;</span>
                <span class="n">float2</span> <span class="n">uv</span>       <span class="o">:</span> <span class="n">TEXCOORD0</span><span class="p">;</span>
                <span class="n">float3</span> <span class="n">normal</span>   <span class="o">:</span> <span class="n">NORMAL</span><span class="p">;</span>
                <span class="n">float4</span> <span class="n">tangent</span>  <span class="o">:</span> <span class="n">TANGENT</span><span class="p">;</span>
            <span class="p">};</span>

  
            <span class="k">struct</span> <span class="n">v2f</span>
            <span class="p">{</span>
                <span class="n">float4</span> <span class="n">pos</span> <span class="o">:</span> <span class="n">SV_POSITION</span><span class="p">;</span>
                <span class="n">float2</span> <span class="n">texcoord</span> <span class="o">:</span> <span class="n">TEXCOORD0</span><span class="p">;</span>
                <span class="n">float3</span> <span class="n">posWS</span> <span class="o">:</span> <span class="n">TEXCOORD1</span><span class="p">;</span>
                <span class="n">float3</span> <span class="n">normalWS</span> <span class="o">:</span><span class="n">TEXCOORD2</span><span class="p">;</span>
                <span class="n">float3</span> <span class="n">tangentWS</span><span class="o">:</span> <span class="n">TEXCOORD3</span><span class="p">;</span>
                <span class="c1">// 阴影坐标声明（自动处理多个变体）</span>
                <span class="n">UNITY_SHADOW_COORDS</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>
            <span class="p">};</span>

            <span class="c1">//sampler2D _MainTex;</span>
            <span class="c1">//float4 _MainTex_ST;</span>

            <span class="n">v2f</span> <span class="n">vert</span> <span class="p">(</span><span class="n">appdata</span> <span class="n">v</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="n">v2f</span> <span class="n">o</span><span class="p">;</span>
                <span class="n">o</span><span class="p">.</span><span class="n">pos</span> <span class="o">=</span> <span class="n">UnityObjectToClipPos</span><span class="p">(</span><span class="n">v</span><span class="p">.</span><span class="n">vertex</span><span class="p">);</span>
                <span class="n">o</span><span class="p">.</span><span class="n">texcoord</span> <span class="o">=</span> <span class="n">TRANSFORM_TEX</span><span class="p">(</span><span class="n">v</span><span class="p">.</span><span class="n">uv</span><span class="p">,</span> <span class="n">_MainTex</span><span class="p">);</span>
                <span class="n">o</span><span class="p">.</span><span class="n">posWS</span> <span class="o">=</span> <span class="n">mul</span><span class="p">(</span><span class="n">unity_ObjectToWorld</span><span class="p">,</span> <span class="n">v</span><span class="p">.</span><span class="n">vertex</span><span class="p">);</span>
                <span class="n">o</span><span class="p">.</span><span class="n">normalWS</span> <span class="o">=</span> <span class="n">UnityObjectToWorldNormal</span><span class="p">(</span><span class="n">v</span><span class="p">.</span><span class="n">normal</span><span class="p">);</span>
                <span class="n">o</span><span class="p">.</span><span class="n">tangentWS</span> <span class="o">=</span> <span class="n">UnityObjectToWorldDir</span><span class="p">(</span><span class="n">v</span><span class="p">.</span><span class="n">tangent</span><span class="p">);</span>

                <span class="c1">// 传输阴影数据（关键！）</span>
                <span class="n">TRANSFER_SHADOW</span><span class="p">(</span><span class="n">o</span><span class="p">);</span>

                <span class="k">return</span> <span class="n">o</span><span class="p">;</span>

            <span class="p">}</span>

  

            <span class="n">fixed4</span> <span class="n">frag</span> <span class="p">(</span><span class="n">v2f</span> <span class="n">i</span><span class="p">)</span> <span class="o">:</span> <span class="n">SV_Target</span>
            <span class="p">{</span>
                <span class="c1">// sample the texture</span>
                <span class="n">fixed4</span> <span class="n">col</span> <span class="o">=</span> <span class="n">tex2D</span><span class="p">(</span><span class="n">_MainTex</span><span class="p">,</span> <span class="n">i</span><span class="p">.</span><span class="n">texcoord</span><span class="p">);</span>

                <span class="n">float3</span> <span class="n">lightDir</span> <span class="o">=</span> <span class="n">normalize</span><span class="p">(</span><span class="n">_WorldSpaceLightPos0</span><span class="p">.</span><span class="n">xyz</span><span class="p">);</span>
                <span class="kt">float</span> <span class="n">nol</span> <span class="o">=</span> <span class="n">max</span><span class="p">(</span><span class="n">dot</span><span class="p">(</span><span class="n">i</span><span class="p">.</span><span class="n">normalWS</span><span class="p">,</span> <span class="n">lightDir</span><span class="p">),</span> <span class="mi">0</span><span class="p">);</span>

                <span class="c1">// 计算阴影衰减（自动处理所有阴影类型）</span>
                <span class="n">fixed</span> <span class="n">shadow</span> <span class="o">=</span> <span class="n">SHADOW_ATTENUATION</span><span class="p">(</span><span class="n">i</span><span class="p">);</span>

                <span class="n">fixed3</span> <span class="n">finalCol</span> <span class="o">=</span> <span class="n">col</span><span class="p">.</span><span class="n">rgb</span> <span class="o">*</span> <span class="n">nol</span> <span class="o">*</span> <span class="n">shadow</span> <span class="o">*</span> <span class="n">_LightColor0</span><span class="p">.</span><span class="n">rgb</span><span class="p">;</span>
                <span class="k">return</span> <span class="n">fixed4</span><span class="p">(</span><span class="n">finalCol</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
            <span class="p">}</span>

            <span class="n">ENDCG</span>

        <span class="p">}</span>

        <span class="n">Pass</span>
        <span class="p">{</span>
            <span class="n">Name</span><span class="s">"ForwadAdd"</span>
            <span class="n">Tags</span>
            <span class="p">{</span>
                <span class="s">"LightMode"</span> <span class="o">=</span> <span class="s">"ForwardAdd"</span>
            <span class="p">}</span>

            <span class="n">Blend</span> <span class="n">One</span> <span class="n">One</span>  <span class="c1">// 加法混合是关键！</span>
            <span class="n">ZWrite</span> <span class="n">Off</span>     <span class="c1">// 避免深度冲突</span>

            <span class="n">CGPROGRAM</span>

            <span class="cp">#pragma vertex vert
</span>            <span class="cp">#pragma fragment frag
</span>            <span class="c1">// 无阴影仅光源衰减需要的变体</span>
            <span class="c1">//#pragma multi_compile_fwdadd</span>
            <span class="c1">// 使用带阴影的编译指令</span>
            <span class="cp">#pragma multi_compile_fwdadd_fullshadows
</span>
            <span class="cp">#include</span> <span class="cpf">"UnityCG.cginc"</span><span class="cp">
</span>            <span class="cp">#include</span> <span class="cpf">"Lighting.cginc"</span><span class="cp">
</span>            <span class="cp">#include</span> <span class="cpf">"AutoLight.cginc"</span><span class="cp">
</span>
  

            <span class="k">struct</span> <span class="n">appdata</span>
            <span class="p">{</span>
                <span class="n">float4</span> <span class="n">vertex</span>  <span class="o">:</span> <span class="n">POSITION</span><span class="p">;</span>
                <span class="n">float2</span> <span class="n">uv</span>      <span class="o">:</span> <span class="n">TEXCOORD0</span><span class="p">;</span>
                <span class="n">float3</span> <span class="n">normal</span>  <span class="o">:</span> <span class="n">NORMAL</span><span class="p">;</span>
                <span class="n">float4</span> <span class="n">tangent</span> <span class="o">:</span> <span class="n">TANGENT</span><span class="p">;</span>
            <span class="p">};</span>

  

            <span class="k">struct</span> <span class="n">v2f</span>
            <span class="p">{</span>
                <span class="n">float4</span> <span class="n">pos</span>      <span class="o">:</span> <span class="n">SV_POSITION</span><span class="p">;</span>
                <span class="n">float2</span> <span class="n">texcoord</span> <span class="o">:</span> <span class="n">TEXCOORD0</span><span class="p">;</span>
                <span class="n">float3</span> <span class="n">posWS</span>    <span class="o">:</span> <span class="n">TEXCOORD1</span><span class="p">;</span>
                <span class="n">float3</span> <span class="n">normalWS</span> <span class="o">:</span> <span class="n">TEXCOORD2</span><span class="p">;</span>
                <span class="n">float3</span> <span class="n">tangentWS</span><span class="o">:</span> <span class="n">TEXCOORD3</span><span class="p">;</span>

                <span class="c1">// 阴影坐标声明（自动处理多个变体）</span>
                <span class="n">UNITY_SHADOW_COORDS</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>
            <span class="p">};</span>

  

            <span class="c1">// sampler2D _MainTex;</span>
            <span class="c1">// float4 _MainTex_ST;</span>
            <span class="n">v2f</span> <span class="n">vert</span> <span class="p">(</span><span class="n">appdata</span> <span class="n">v</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="n">v2f</span> <span class="n">o</span><span class="p">;</span>
                <span class="n">o</span><span class="p">.</span><span class="n">pos</span> <span class="o">=</span> <span class="n">UnityObjectToClipPos</span><span class="p">(</span><span class="n">v</span><span class="p">.</span><span class="n">vertex</span><span class="p">);</span>
                <span class="n">o</span><span class="p">.</span><span class="n">texcoord</span> <span class="o">=</span> <span class="n">TRANSFORM_TEX</span><span class="p">(</span><span class="n">v</span><span class="p">.</span><span class="n">uv</span><span class="p">,</span> <span class="n">_MainTex</span><span class="p">);</span>
                <span class="n">o</span><span class="p">.</span><span class="n">posWS</span> <span class="o">=</span> <span class="n">mul</span><span class="p">(</span><span class="n">unity_ObjectToWorld</span><span class="p">,</span> <span class="n">v</span><span class="p">.</span><span class="n">vertex</span><span class="p">);</span>
                <span class="n">o</span><span class="p">.</span><span class="n">normalWS</span> <span class="o">=</span> <span class="n">UnityObjectToWorldNormal</span><span class="p">(</span><span class="n">v</span><span class="p">.</span><span class="n">normal</span><span class="p">);</span>
                <span class="n">o</span><span class="p">.</span><span class="n">tangentWS</span> <span class="o">=</span> <span class="n">UnityObjectToWorldDir</span><span class="p">(</span><span class="n">v</span><span class="p">.</span><span class="n">tangent</span><span class="p">);</span>

                <span class="c1">// 传输阴影数据（关键！）</span>
                <span class="n">TRANSFER_SHADOW</span><span class="p">(</span><span class="n">o</span><span class="p">);</span>
                <span class="k">return</span> <span class="n">o</span><span class="p">;</span>
            <span class="p">}</span>

  

            <span class="n">fixed4</span> <span class="n">frag</span> <span class="p">(</span><span class="n">v2f</span> <span class="n">i</span><span class="p">)</span> <span class="o">:</span> <span class="n">SV_Target</span>
            <span class="p">{</span>

                <span class="c1">// sample the texture</span>
                <span class="n">fixed4</span> <span class="n">col</span> <span class="o">=</span> <span class="n">tex2D</span><span class="p">(</span><span class="n">_MainTex</span><span class="p">,</span> <span class="n">i</span><span class="p">.</span><span class="n">texcoord</span><span class="p">);</span>

                <span class="c1">// 关键：附加光源的方向计算</span>
                <span class="cp">#ifdef USING_DIRECTIONAL_LIGHT
</span>                    <span class="n">float3</span> <span class="n">lightDir</span> <span class="o">=</span> <span class="n">normalize</span><span class="p">(</span><span class="n">_WorldSpaceLightPos0</span><span class="p">.</span><span class="n">xyz</span><span class="p">);</span>
                <span class="cp">#else
</span>                    <span class="n">float3</span> <span class="n">lightDir</span> <span class="o">=</span> <span class="n">normalize</span><span class="p">(</span><span class="n">_WorldSpaceLightPos0</span><span class="p">.</span><span class="n">xyz</span> <span class="o">-</span> <span class="n">i</span><span class="p">.</span><span class="n">posWS</span><span class="p">);</span>
                <span class="cp">#endif
</span>
                <span class="c1">// 计算阴影衰减（自动处理所有阴影类型）</span>
                <span class="c1">//fixed shadow = SHADOW_ATTENUATION(i);</span>

                <span class="kt">float</span> <span class="n">nol</span> <span class="o">=</span> <span class="n">max</span><span class="p">(</span><span class="n">dot</span><span class="p">(</span><span class="n">i</span><span class="p">.</span><span class="n">normalWS</span><span class="p">,</span> <span class="n">lightDir</span><span class="p">),</span> <span class="mi">0</span><span class="p">);</span>

                <span class="c1">// 阴影和衰减</span>
                <span class="n">UNITY_LIGHT_ATTENUATION</span><span class="p">(</span><span class="n">atten</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">i</span><span class="p">.</span><span class="n">posWS</span><span class="p">);</span>

  

                <span class="n">fixed3</span> <span class="n">finalCol</span> <span class="o">=</span> <span class="n">col</span><span class="p">.</span><span class="n">rgb</span> <span class="o">*</span> <span class="n">nol</span> <span class="o">*</span> <span class="n">atten</span> <span class="o">*</span> <span class="n">_LightColor0</span><span class="p">.</span><span class="n">rgb</span><span class="p">;</span>
                <span class="k">return</span> <span class="n">fixed4</span><span class="p">(</span><span class="n">finalCol</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

            <span class="p">}</span>
            <span class="n">ENDCG</span>
        <span class="p">}</span>

        <span class="n">Pass</span>
        <span class="p">{</span>

            <span class="n">Name</span><span class="s">"ShadowCaster"</span>
            <span class="n">Tags</span><span class="p">{</span>
                <span class="s">"LightMode"</span> <span class="o">=</span> <span class="s">"ShadowCaster"</span>
            <span class="p">}</span>

            <span class="n">CGPROGRAM</span>
            <span class="cp">#pragma vertex vert
</span>            <span class="cp">#pragma fragment frag
</span>
            <span class="c1">// 阴影投射需要的变体</span>
            <span class="cp">#pragma multi_compile_shadowcaster
</span>            <span class="cp">#include</span> <span class="cpf">"UnityCG.cginc"</span><span class="cp">
</span>
            <span class="k">struct</span> <span class="n">appdata</span>

            <span class="p">{</span>
                <span class="n">float4</span> <span class="n">vertex</span> <span class="o">:</span> <span class="n">POSITION</span><span class="p">;</span>
                <span class="n">float3</span> <span class="n">normal</span> <span class="o">:</span> <span class="n">NORMAL</span><span class="p">;</span>
            <span class="p">};</span>

            <span class="k">struct</span> <span class="n">v2f</span>
            <span class="p">{</span>
                <span class="n">V2F_SHADOW_CASTER</span><span class="p">;</span>  <span class="c1">// Unity预定义的结构</span>
            <span class="p">};</span>

            <span class="n">v2f</span> <span class="n">vert</span><span class="p">(</span><span class="n">appdata</span> <span class="n">v</span><span class="p">)</span>
            <span class="p">{</span>

                <span class="n">v2f</span> <span class="n">o</span><span class="p">;</span>
                <span class="n">TRANSFER_SHADOW_CASTER_NORMALOFFSET</span><span class="p">(</span><span class="n">o</span><span class="p">)</span>  <span class="c1">// 转换到阴影空间</span>
                <span class="k">return</span> <span class="n">o</span><span class="p">;</span>
            <span class="p">}</span>

            <span class="n">fixed4</span> <span class="n">frag</span><span class="p">(</span><span class="n">v2f</span> <span class="n">i</span><span class="p">)</span> <span class="o">:</span> <span class="n">SV_Target</span>
            <span class="p">{</span>
                <span class="n">SHADOW_CASTER_FRAGMENT</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>  <span class="c1">// 写入阴影深度</span>
            <span class="p">}</span>
            <span class="n">ENDCG</span>
        <span class="p">}</span>
    <span class="p">}</span>
    <span class="n">FallBack</span> <span class="s">"Diffuse"</span>
<span class="p">}</span>

</pre></td> </tr></tbody></table></code></pre></div></div> </div> </article> <br> <hr> <br> <ul class="list-disc pl-8"></ul> <h2 class="text-3xl font-semibold mb-4 mt-12">Enjoy Reading This Article?</h2> <p class="mb-2">Here are some more articles you might like to read next:</p> <li class="my-2"> <a class="text-pink-700 underline font-semibold hover:text-pink-800" href="/blog/2025/%E7%90%86%E8%AE%BA%E6%94%AF%E7%BA%BF-PBRSpecular-GGX-%E9%80%9F%E9%80%9A/">理论支线：PBRSpecular - GGX 速通</a> </li> <li class="my-2"> <a class="text-pink-700 underline font-semibold hover:text-pink-800" href="/blog/2025/GGX_D(H)%E5%88%86%E5%B8%83%E5%8F%AF%E8%A7%86%E5%8C%96/">GGX_D(H)分布可视化</a> </li> <li class="my-2"> <a class="text-pink-700 underline font-semibold hover:text-pink-800" href="/blog/2025/Lv.2-Unity%E4%B8%BB%E7%BA%BF-%E6%B7%BB%E5%8A%A0%E7%8E%AF%E5%A2%83%E5%85%89/">Lv.2 Unity主线：添加环境光</a> </li> <li class="my-2"> <a class="text-pink-700 underline font-semibold hover:text-pink-800" href="/blog/2025/Lv.2-Unity%E4%B8%BB%E7%BA%BF-%E9%95%9C%E9%9D%A2%E5%8F%8D%E5%B0%84%E5%85%89%E7%85%A7%E6%A8%A1%E5%9E%8BPhong%E5%92%8CBlinn-Phong/">镜面反射光照模型Phong和Blinn-Phong</a> </li> <li class="my-2"> <a class="text-pink-700 underline font-semibold hover:text-pink-800" href="/blog/2025/Lv.2-Unity%E4%B8%BB%E7%BA%BF-%E6%B7%BB%E5%8A%A0%E6%B3%95%E7%BA%BF/">Lv.2 Unity主线：添加法线</a> </li> </div> # # <script>
# (function() {
#   'use strict';
  
#   document.addEventListener('DOMContentLoaded', function() {
#     // 检查 Medium Zoom 是否可用
#     if (typeof mediumZoom !== 'undefined') {
#       // 使用 Medium Zoom
#       mediumZoom('.post-content img:not([width]):not([style])', {
#         margin: 24,
#         background: 'rgba(0, 0, 0, 0.9)',
#         scrollOffset: 0
#       });
#       console.log('Medium Zoom enabled');
#     } else {
#       // 如果没有 Medium Zoom，手动添加点击事件
#       const images = document.querySelectorAll('.post-content img:not([width]):not([style])');
#       images.forEach(function(img) {
#         img.style.cursor = 'zoom-in';
#         img.addEventListener('click', function() {
#           // 简单的全屏显示
#           const overlay = document.createElement('div');
#           overlay.style.cssText = 'position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.9);z-index:9999;display:flex;align-items:center;justify-content:center;cursor:zoom-out;';
          
#           const enlargedImg = document.createElement('img');
#           enlargedImg.src = this.src;
#           enlargedImg.style.cssText = 'max-width:90%;max-height:90%;object-fit:contain;';
          
#           overlay.appendChild(enlargedImg);
#           document.body.appendChild(overlay);
          
#           overlay.addEventListener('click', function() {
#             document.body.removeChild(overlay);
#           });
#         });
#       });
#       console.log('Manual zoom enabled for', images.length, 'images');
#     }
#   });
# })();
# </script> <script>
(function() {
  'use strict';
  
  document.addEventListener('DOMContentLoaded', function() {
    
    
    const selector = '.post-content img:not([width]):not([style]):not([data-spotlight-converted])';
    const images = document.querySelectorAll(selector);
    
    if (images.length === 0) {
      console.log('Spotlight: No images to convert');
      return;
    }
    
    images.forEach(function(img) {
      if (img.parentElement.classList.contains('spotlight')) {
        return;
      }
      
      const link = document.createElement('a');
      link.className = 'spotlight';
      link.href = img.src;
      
      if (img.alt) {
        link.setAttribute('data-description', img.alt);
      }
      
      img.setAttribute('data-spotlight-converted', 'true');
      
      // 强制设置样式（防止被覆盖）
      img.style.cssText = 'max-width: 75% !important; display: block !important; margin: 1em auto !important; cursor: zoom-in !important;';
      
      const parent = img.parentNode;
      parent.insertBefore(link, img);
      link.appendChild(img);
    });
    
    console.log('Spotlight: Converted', images.length, 'images');
    
    
  });
})();
</script> </div> </div> </div> <footer class="fixed-bottom" role="contentinfo"> <div class="container mt-0"> © Copyright 2025 吟处雪 轻遮. Powered by <a href="https://jekyllrb.com/" target="_blank" rel="external nofollow noopener">Jekyll</a> with <a href="https://github.com/alshedivat/al-folio" target="_blank" rel="external nofollow noopener">al-folio</a> theme. Hosted by <a href="https://pages.github.com/" target="_blank" rel="external nofollow noopener">GitHub Pages</a>. </div> </footer> <script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js" integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script> <script src="/assets/js/bootstrap.bundle.min.js"></script> <script src="https://cdn.jsdelivr.net/npm/mdbootstrap@4.20.0/js/mdb.min.js" integrity="sha256-NdbiivsvWt7VYCt6hYNT3h/th9vSTL4EDWeGs5SN3DA=" crossorigin="anonymous"></script> <script defer src="https://cdn.jsdelivr.net/npm/masonry-layout@4.2.2/dist/masonry.pkgd.min.js" integrity="sha256-Nn1q/fx0H7SNLZMQ5Hw5JLaTRZp0yILA/FRexe19VdI=" crossorigin="anonymous"></script> <script defer src="https://cdn.jsdelivr.net/npm/imagesloaded@5.0.0/imagesloaded.pkgd.min.js" integrity="sha256-htrLFfZJ6v5udOG+3kNLINIKh2gvoKqwEhHYfTTMICc=" crossorigin="anonymous"></script> <script defer src="/assets/js/masonry.js?a0db7e5d5c70cc3252b3138b0c91dcaf" type="text/javascript"></script> <script defer src="https://cdn.jsdelivr.net/npm/medium-zoom@1.1.0/dist/medium-zoom.min.js" integrity="sha256-ZgMyDAIYDYGxbcpJcfUnYwNevG/xi9OHKaR/8GK+jWc=" crossorigin="anonymous"></script> <script defer src="/assets/js/zoom.js?85ddb88934d28b74e78031fd54cf8308"></script> <script defer src="/assets/js/bootstrap-toc.min.js?c82ff4de8b0955d6ff14f5b05eed7eb6"></script> <script src="/assets/js/no_defer.js?2781658a0a2b13ed609542042a859126"></script> <script defer src="/assets/js/common.js?c15de51d4bb57887caa2c21988d97279"></script> <script defer src="/assets/js/copy_code.js?c8a01c11a92744d44b093fc3bda915df" type="text/javascript"></script> <script defer src="/assets/js/jupyter_new_tab.js?d9f17b6adc2311cbabd747f4538bb15f"></script> <script async src="https://d1bxh8uas1mnw7.cloudfront.net/assets/embed.js"></script> <script async src="https://badge.dimensions.ai/badge.js"></script> <script defer type="text/javascript" id="MathJax-script" src="https://cdn.jsdelivr.net/npm/mathjax@3.2.2/es5/tex-mml-chtml.js" integrity="sha256-MASABpB4tYktI2Oitl4t+78w/lyA+D7b/s9GEP0JOGI=" crossorigin="anonymous"></script> <script src="/assets/js/mathjax-setup.js?a5bb4e6a542c546dd929b24b8b236dfd"></script> <script defer src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?features=es6" crossorigin="anonymous"></script> <script defer src="/assets/js/progress-bar.js?2f30e0e6801ea8f5036fa66e1ab0a71a" type="text/javascript"></script> <script defer src="https://cdn.jsdelivr.net/npm/spotlight.js@0.7.8/dist/spotlight.bundle.min.js" crossorigin="anonymous"></script> <script src="/assets/js/vanilla-back-to-top.min.js?f40d453793ff4f64e238e420181a1d17"></script> <script>
    addBackToTop();
  </script> <script type="module" src="/assets/js/search/ninja-keys.min.js?a3446f084dcaecc5f75aa1757d087dcf"></script> <ninja-keys hidebreadcrumbs noautoloadmdicons placeholder="Type to start searching"></ninja-keys> <script src="/assets/js/search-setup.js?6c304f7b1992d4b60f7a07956e52f04a"></script> <script src="/assets/js/search-data.js"></script> <script src="/assets/js/shortcut-key.js?6f508d74becd347268a7f822bca7309d"></script> </body> </html>